{
  "openapi": "3.1.0",
  "info": {
    "title": "ONDC Integration API",
    "version": "1.0.0",
    "description": "\n# ONDC Integration API\n\nThis API provides integration endpoints for the Open Network for Digital Commerce (ONDC) platform.\n\n## What is ONDC?\n\nONDC (Open Network for Digital Commerce) is a Government of India initiative to democratize e-commerce by creating an open, interoperable network. It allows buyers and sellers to transact across different platforms without being locked into a single marketplace.\n\n## API Organization\n\nThis API is organized into three groups:\n\n- **Registry**: Endpoints that communicate with the ONDC Registry for subscriber management\n- **Gateway**: Endpoints that communicate with the ONDC Gateway for transaction flows\n- **Internal**: Utility endpoints for health checks and result polling\n\n## Authentication\n\nThis API uses two different authentication patterns:\n\n### Outbound Requests (Your App → ONDC)\nRoutes: `/api/ondc/lookup`, `/api/ondc/subscribe`, `/api/ondc/search`, `/api/ondc/select`\n\nUses **Ed25519 HTTP Signatures** with BLAKE-512 digest. See the \"Ed25519Signature\" security scheme for detailed implementation guide.\n\n### Inbound Callbacks (ONDC → Your App)\nRoutes: `/api/ondc/on_subscribe`, `/api/ondc/on_search`, `/api/ondc/on_select`\n\nONDC/BPPs sign their requests to you. Your app should verify their signatures using their public keys from the registry.\n\n## External Documentation\n\n- [ONDC Official Website](https://ondc.org/)\n- [Beckn Protocol Documentation](https://developers.becknprotocol.io/)\n- [ONDC FIS Specifications (Insurance)](https://github.com/ONDC-Official/ONDC-FIS-Specifications)\n    ",
    "contact": {
      "name": "Vaatun Technologies",
      "email": "vaibhav@vaatun.com"
    },
    "license": {
      "name": "MIT"
    }
  },
  "servers": [
    {
      "url": "http://localhost:3000",
      "description": "Local development"
    },
    {
      "url": "https://ondc-staging.vaatun.com",
      "description": "Staging environment"
    }
  ],
  "components": {
    "schemas": {
      "HealthResponse": {
        "type": "object",
        "properties": {
          "status": {
            "type": "string",
            "example": "Health OK!!"
          },
          "ready": {
            "type": "boolean",
            "example": true
          }
        },
        "required": [
          "status",
          "ready"
        ]
      },
      "Subscriber": {
        "type": "object",
        "properties": {
          "subscriber_id": {
            "type": "string",
            "example": "ondc-staging.vaatun.com"
          },
          "subscriber_url": {
            "type": "string"
          },
          "type": {
            "type": "string",
            "example": "bap"
          },
          "domain": {
            "type": "string",
            "example": "ONDC:FIS13"
          },
          "city": {
            "type": "string",
            "example": "std:080"
          },
          "country": {
            "type": "string",
            "example": "IND"
          },
          "signing_public_key": {
            "type": "string",
            "example": "MCowBQYDK2VwAyEA..."
          },
          "encr_public_key": {
            "type": "string",
            "example": "MCowBQYDK2VuAyEA..."
          },
          "valid_from": {
            "type": "string",
            "example": "2024-01-01T00:00:00.000Z"
          },
          "valid_until": {
            "type": "string",
            "example": "2025-12-31T23:59:59.999Z"
          },
          "status": {
            "type": "string"
          },
          "created": {
            "type": "string"
          },
          "updated": {
            "type": "string"
          }
        },
        "required": [
          "subscriber_id",
          "type",
          "domain",
          "signing_public_key",
          "encr_public_key",
          "valid_from",
          "valid_until"
        ],
        "additionalProperties": {}
      },
      "LookupResponse": {
        "type": "array",
        "items": {
          "$ref": "#/components/schemas/Subscriber"
        }
      }
    },
    "parameters": {},
    "securitySchemes": {
      "Ed25519Signature": {
        "type": "apiKey",
        "in": "header",
        "name": "Authorization",
        "description": "\n# ONDC Ed25519 Signature Authentication\n\nAll outbound requests to ONDC Registry and Gateway require Ed25519 digital signatures using HTTP Signature standard.\n\n## Authentication Flow\n\n### Step 1: Calculate BLAKE-512 Digest\n```typescript\nimport { createHash } from \"crypto\";\n\nconst requestBody = JSON.stringify(payload);\nconst digest = createHash(\"blake2b512\")\n  .update(requestBody)\n  .digest(\"base64\");\n```\n\n### Step 2: Create Signing String\n```typescript\nconst created = Math.floor(Date.now() / 1000) - 3; // Clock drift compensation\nconst expires = created + 300; // 5 minute validity\n\nconst signingString =\n  `(created): ${created}\\n` +\n  `(expires): ${expires}\\n` +\n  `digest: BLAKE-512=${digest}`;\n```\n\n### Step 3: Sign with Ed25519\n```typescript\nimport sodium from \"libsodium-wrappers\";\n\nawait sodium.ready;\n\nconst privateKey = sodium.from_base64(process.env.SIGNING_PRIVATE_KEY);\nconst signature = sodium.crypto_sign_detached(signingString, privateKey);\nconst signatureBase64 = sodium.to_base64(signature);\n```\n\n### Step 4: Construct Authorization Header\n```typescript\nconst keyId = `${subscriberId}|${uniqueKeyId}|ed25519`;\n\nconst authHeader =\n  `Signature keyId=\"${keyId}\",` +\n  `algorithm=\"ed25519\",` +\n  `created=\"${created}\",` +\n  `expires=\"${expires}\",` +\n  `headers=\"(created) (expires) digest\",` +\n  `signature=\"${signatureBase64}\"`;\n```\n\n## Clock Drift Compensation\n\nThe implementation subtracts 3 seconds from the current timestamp to account for clock drift between your server and ONDC servers:\n\n```typescript\nconst created = Math.floor(Date.now() / 1000) - 3; // Subtract 3 seconds\n```\n\nThis prevents authentication failures due to slight time differences.\n\n## Key Management\n\n### Environment Variables Required\n\n- `SIGNING_PRIVATE_KEY`: Ed25519 private key (base64-encoded, 64 bytes)\n- `UNIQUE_KEY_ID`: Unique identifier for this key pair (e.g., \"custom-key-id\")\n- `SUBSCRIBER_ID`: Your registered ONDC subscriber ID (e.g., \"ondc-staging.vaatun.com\")\n\n## Implementation Reference\n\nSee full implementation in:\n- `/src/lib/ondc/client.ts` - ONDCClient.createAuthorizationHeader()\n- `/src/lib/ondc/signing.ts` - Ed25519 signing utilities\n- `/src/entities/tenant.ts` - Key management\n\n## Inbound vs Outbound Authentication\n\n### Outbound (Your App → ONDC)\n- **Routes**: `/api/ondc/lookup`, `/api/ondc/subscribe`, `/api/ondc/search`, `/api/ondc/select`\n- **You sign**: Using your `SIGNING_PRIVATE_KEY`\n- **ONDC verifies**: Using your public key from registry\n\n### Inbound (ONDC → Your App)\n- **Routes**: `/api/ondc/on_subscribe`, `/api/ondc/on_search`, `/api/ondc/on_select`\n- **ONDC signs**: Using their private key\n- **You verify**: Using their public key from registry (retrieved via `/lookup`)\n    "
      }
    }
  },
  "paths": {
    "/api/ondc/health": {
      "get": {
        "summary": "Health Check",
        "description": "Service health monitoring endpoint. Returns service status and readiness. Verifies that tenant configuration is loaded and ONDC client is initialized.",
        "tags": [
          "Internal"
        ],
        "operationId": "healthCheck",
        "directoryConfig": {
          "title": "Health Check",
          "description": "Check if the service is running"
        },
        "responses": {
          "200": {
            "description": "Service is healthy and ready",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/HealthResponse"
                }
              }
            }
          },
          "503": {
            "description": "Service is not ready",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/HealthResponse"
                }
              }
            }
          }
        }
      }
    },
    "/api/ondc/lookup": {
      "get": {
        "summary": "Lookup Tenant Subscription",
        "description": "Look up the current tenant's subscription in the ONDC registry.\n\nThis endpoint queries the ONDC Registry using the configured tenant's subscriber ID and domain code to retrieve registration details.\n\n**Use Cases:**\n- Verify tenant registration status\n- Retrieve public keys for the tenant\n- Check subscription validity",
        "tags": [
          "Registry"
        ],
        "operationId": "lookup",
        "externalDocs": {
          "description": "Beckn Registry API - Lookup Specification",
          "url": "https://developers.becknprotocol.io/docs/registry-api-reference/registry/lookup"
        },
        "directoryConfig": {
          "title": "Registry Lookup",
          "description": "Look up tenant subscription in the ONDC registry"
        },
        "responses": {
          "200": {
            "description": "Successful lookup",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/LookupResponse"
                }
              }
            }
          },
          "500": {
            "description": "Server error"
          }
        }
      }
    }
  },
  "webhooks": {},
  "tags": [
    {
      "name": "Registry",
      "description": "Endpoints that communicate with the ONDC Registry for subscriber management, lookup, and verification. Includes both outbound requests (lookup, subscribe) and inbound callbacks (on_subscribe).",
      "externalDocs": {
        "description": "Beckn Registry API Reference",
        "url": "https://developers.becknprotocol.io/docs/registry-api-reference/"
      }
    },
    {
      "name": "Gateway",
      "description": "Endpoints that communicate with the ONDC Gateway for transaction flows (search, select, etc.). Includes both outbound requests and inbound callbacks from BPPs (on_search, on_select).",
      "externalDocs": {
        "description": "Beckn Core Specification",
        "url": "https://developers.becknprotocol.io/docs/core-specification/"
      }
    },
    {
      "name": "Internal",
      "description": "Utility endpoints for health checks, result polling, and internal operations. These endpoints are not part of the ONDC protocol."
    }
  ]
}