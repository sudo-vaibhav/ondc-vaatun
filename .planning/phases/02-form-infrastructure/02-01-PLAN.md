---
phase: 02-form-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - client/package.json
  - client/src/hooks/useFormPersistence.ts
  - client/src/lib/form-schemas/personal-info.ts
  - client/src/lib/form-schemas/pan-dob.ts
  - client/src/lib/form-schemas/ped.ts
  - client/src/lib/form-formatters.ts
autonomous: true

must_haves:
  truths:
    - "Form schemas validate personal info, PAN/DOB, and PED data"
    - "useFormPersistence hook saves to localStorage on demand"
    - "useFormPersistence hook retrieves stored data"
    - "PAN formatter returns uppercase alphanumeric, max 10 chars"
    - "Phone formatter returns digits only, max 10 chars"
  artifacts:
    - path: "client/src/hooks/useFormPersistence.ts"
      provides: "localStorage persistence hook"
      exports: ["useFormPersistence"]
    - path: "client/src/lib/form-schemas/personal-info.ts"
      provides: "Zod schema for personal info step"
      exports: ["personalInfoSchema", "PersonalInfoData"]
    - path: "client/src/lib/form-schemas/pan-dob.ts"
      provides: "Zod schema for PAN/DOB step"
      exports: ["panDobSchema", "PanDobData"]
    - path: "client/src/lib/form-schemas/ped.ts"
      provides: "Zod schema for PED step"
      exports: ["pedSchema", "PedData"]
    - path: "client/src/lib/form-formatters.ts"
      provides: "Input formatting functions"
      exports: ["formatPAN", "formatPhone", "formatDOB"]
  key_links:
    - from: "client/src/lib/form-schemas/*.ts"
      to: "zod"
      via: "import { z } from 'zod'"
      pattern: "z\\.object\\("
---

<objective>
Install form dependencies and create foundational hooks, schemas, and utilities for the multi-step form system.

Purpose: Establish the core infrastructure (React Hook Form, Zod schemas, localStorage persistence, input formatters) that all form components will depend on.

Output: Installed dependencies, useFormPersistence hook, three Zod form schemas, and formatting utilities.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-form-infrastructure/CONTEXT.md
@.planning/phases/02-form-infrastructure/02-RESEARCH.md
@client/src/lib/purchaser-context.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install React Hook Form dependencies</name>
  <files>client/package.json</files>
  <action>
Install react-hook-form and @hookform/resolvers packages:

```bash
cd client && pnpm add react-hook-form @hookform/resolvers
```

These packages enable:
- react-hook-form: Performant form state management with uncontrolled inputs
- @hookform/resolvers: Bridges Zod schemas to React Hook Form validation
  </action>
  <verify>Run `cat client/package.json | grep -E "(react-hook-form|hookform)"` - should show both packages</verify>
  <done>react-hook-form and @hookform/resolvers appear in client/package.json dependencies</done>
</task>

<task type="auto">
  <name>Task 2: Create useFormPersistence hook and form schemas</name>
  <files>
    client/src/hooks/useFormPersistence.ts
    client/src/lib/form-schemas/personal-info.ts
    client/src/lib/form-schemas/pan-dob.ts
    client/src/lib/form-schemas/ped.ts
  </files>
  <action>
**Create hooks directory and useFormPersistence hook:**

File: `client/src/hooks/useFormPersistence.ts`

Implement the hook with these capabilities:
- `getStoredData()`: Retrieve saved form data from localStorage
- `saveData(data)`: Save form data to localStorage (called on blur per CONTEXT.md)
- `clearData()`: Remove form data from localStorage
- `hasStoredData()`: Check if any data exists (for resume prompt)

Use storage key pattern: `ondc-form-{formId}` (see purchaser-context.tsx for reference pattern).

Handle SSR-safety: Check `typeof window !== "undefined"` before localStorage access.

**Create form schemas directory and three schema files:**

File: `client/src/lib/form-schemas/personal-info.ts`
- firstName: string, min 1 char, "First name is required"
- lastName: string, min 1 char, "Last name is required"
- email: string, email format, "Invalid email address"
- phone: string, regex /^[6-9]\d{9}$/, "Invalid 10-digit mobile number"
- address: string, min 1 char, "Address is required"
- pincode: string, length 6, "Pincode must be 6 digits"
- city: string, min 1 char, "City is required"
- state: string, min 1 char, "State is required"

Export: personalInfoSchema, type PersonalInfoData

File: `client/src/lib/form-schemas/pan-dob.ts`
- panNumber: string, length 10, regex /^[A-Z]{5}[0-9]{4}[A-Z]{1}$/, "Invalid PAN format (e.g., ABCDE1234F)"
- dateOfBirth: string, min 1 char, "Date of birth is required"

Export: panDobSchema, type PanDobData

File: `client/src/lib/form-schemas/ped.ts`
- hasPED: boolean
- conditions: object with boolean fields for:
  - diabetes
  - bloodPressure (label: "Blood Pressure / Hypertension")
  - heartAilments (label: "Heart Ailments")
  - asthma (label: "Asthma / Respiratory")
  - thyroid (label: "Thyroid Disorders")
  - cancer
  - other
- otherDescription: string, optional (required only when conditions.other is true)

Use Zod's refine() for conditional validation: if conditions.other is true, otherDescription must have content.

Export: pedSchema, type PedData, pedConditionLabels (object mapping condition keys to display labels)
  </action>
  <verify>
Run TypeScript check: `cd client && npx tsc --noEmit` - should pass without errors on the new files.
Import test: Create a quick test by adding imports at top of any existing file and ensuring no type errors.
  </verify>
  <done>
- useFormPersistence hook exports getStoredData, saveData, clearData, hasStoredData functions
- personalInfoSchema validates 8 fields with proper error messages
- panDobSchema validates PAN format with regex
- pedSchema validates conditions with conditional otherDescription
  </done>
</task>

<task type="auto">
  <name>Task 3: Create form input formatters</name>
  <files>client/src/lib/form-formatters.ts</files>
  <action>
Create input formatting functions (applied on blur per CONTEXT.md):

File: `client/src/lib/form-formatters.ts`

```typescript
/**
 * Format PAN to uppercase, remove non-alphanumeric, max 10 chars
 * Applied on blur, not real-time (per CONTEXT.md)
 */
export function formatPAN(value: string): string {
  return value.toUpperCase().replace(/[^A-Z0-9]/g, "").slice(0, 10);
}

/**
 * Format phone to digits only, max 10 chars
 * Applied on blur, not real-time (per CONTEXT.md)
 */
export function formatPhone(value: string): string {
  return value.replace(/\D/g, "").slice(0, 10);
}

/**
 * Format DOB to YYYY-MM-DD (ISO format)
 * If already in format, returns as-is
 * Applied on blur, not real-time (per CONTEXT.md)
 */
export function formatDOB(value: string): string {
  // Already in ISO format
  if (/^\d{4}-\d{2}-\d{2}$/.test(value)) return value;

  // Try to parse and format
  const date = new Date(value);
  if (Number.isNaN(date.getTime())) return value;

  return date.toISOString().split("T")[0];
}

/**
 * Format pincode to digits only, max 6 chars
 */
export function formatPincode(value: string): string {
  return value.replace(/\D/g, "").slice(0, 6);
}
```
  </action>
  <verify>
Manual verification in terminal:
```bash
cd client && node -e "
const { formatPAN, formatPhone } = require('./src/lib/form-formatters.ts');
console.log(formatPAN('abcde1234f') === 'ABCDE1234F');
console.log(formatPhone('98765-43210') === '9876543210');
"
```
Note: If ESM import fails, just verify TypeScript compiles: `npx tsc --noEmit`
  </verify>
  <done>
- formatPAN("abcde 1234f") returns "ABCDE1234F"
- formatPhone("98765-43210") returns "9876543210"
- formatDOB("2024-01-15") returns "2024-01-15"
- formatPincode("110 001") returns "110001"
  </done>
</task>

</tasks>

<verification>
1. `pnpm install` completes without errors
2. `cd client && npx tsc --noEmit` passes
3. All new files exist and export expected types/functions
4. Form schemas reject invalid data (test with z.parse on bad input)
</verification>

<success_criteria>
- react-hook-form and @hookform/resolvers installed in client
- useFormPersistence hook created with localStorage operations
- Three Zod schemas (personal-info, pan-dob, ped) created with proper validation
- Formatter functions created for PAN, phone, DOB, pincode
- TypeScript compilation passes
</success_criteria>

<output>
After completion, create `.planning/phases/02-form-infrastructure/02-01-SUMMARY.md`
</output>
