---
phase: 02-form-infrastructure
plan: 04
type: execute
wave: 3
depends_on: ["02-02", "02-03"]
files_modified:
  - client/src/components/forms/index.ts
  - client/src/components/forms/KYCForm.tsx
  - client/src/lib/submission-id.ts
autonomous: true

must_haves:
  truths:
    - "KYCForm navigates between 3 steps with smooth slide animations"
    - "KYCForm validates each step on blur using React Hook Form"
    - "KYCForm auto-saves to localStorage on blur"
    - "KYCForm shows ResumePrompt when returning with saved data"
    - "Form submission generates a unique submission_id"
  artifacts:
    - path: "client/src/components/forms/index.ts"
      provides: "Barrel export for all form components"
      exports: ["MultiStepForm", "FormStep", "StepProgress", "ResumePrompt", "KYCForm"]
    - path: "client/src/components/forms/KYCForm.tsx"
      provides: "Complete KYC form demonstrating form infrastructure"
      exports: ["KYCForm", "KYCFormProps"]
    - path: "client/src/lib/submission-id.ts"
      provides: "Submission ID generation utility"
      exports: ["generateSubmissionId"]
  key_links:
    - from: "client/src/components/forms/KYCForm.tsx"
      to: "client/src/hooks/useFormPersistence.ts"
      via: "useFormPersistence hook for auto-save"
      pattern: "useFormPersistence"
    - from: "client/src/components/forms/KYCForm.tsx"
      to: "react-hook-form"
      via: "useForm with mode: 'onBlur'"
      pattern: "useForm.*mode.*onBlur"
    - from: "client/src/components/forms/KYCForm.tsx"
      to: "client/src/components/forms/MultiStepForm.tsx"
      via: "MultiStepForm container"
      pattern: "import.*MultiStepForm"
---

<objective>
Create the integrated KYC form that demonstrates the complete form infrastructure with all components working together.

Purpose: Wire up all form components (MultiStepForm, FormStep, StepProgress, field components, persistence hook) into a working 3-step KYC form that satisfies Phase 2 success criteria.

Output: A complete KYCForm component that can be used in Phase 3 (Init Flow) and demonstrates all FORM-* requirements.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-form-infrastructure/CONTEXT.md
@.planning/phases/02-form-infrastructure/02-RESEARCH.md
@.planning/phases/02-form-infrastructure/02-01-SUMMARY.md
@.planning/phases/02-form-infrastructure/02-02-SUMMARY.md
@.planning/phases/02-form-infrastructure/02-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create submission ID utility</name>
  <files>client/src/lib/submission-id.ts</files>
  <action>
Per FORM-08: "Form submission generates submission_id for ONDC protocol compliance"

File: `client/src/lib/submission-id.ts`

```typescript
/**
 * Generate a unique submission ID for ONDC protocol compliance.
 * Uses crypto.randomUUID() for browser-native UUID v4 generation.
 *
 * Format: UUID v4 (e.g., "550e8400-e29b-41d4-a716-446655440000")
 */
export function generateSubmissionId(): string {
  // crypto.randomUUID() is available in all modern browsers (Chrome 92+, Firefox 95+, Safari 15.4+)
  // and Node.js 19+
  if (typeof crypto !== "undefined" && crypto.randomUUID) {
    return crypto.randomUUID();
  }

  // Fallback for older environments (unlikely in modern browsers)
  return "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g, (c) => {
    const r = (Math.random() * 16) | 0;
    const v = c === "x" ? r : (r & 0x3) | 0x8;
    return v.toString(16);
  });
}

/**
 * Validate that a string is a valid UUID v4 format
 */
export function isValidSubmissionId(id: string): boolean {
  const uuidV4Regex =
    /^[0-9a-f]{8}-[0-9a-f]{4}-4[0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i;
  return uuidV4Regex.test(id);
}
```
  </action>
  <verify>
1. File exists at client/src/lib/submission-id.ts
2. TypeScript compiles: `cd client && npx tsc --noEmit`
3. Exports generateSubmissionId and isValidSubmissionId
  </verify>
  <done>
- generateSubmissionId() returns a UUID v4 string
- isValidSubmissionId() validates UUID v4 format
- Works in browser environment with crypto.randomUUID()
  </done>
</task>

<task type="auto">
  <name>Task 2: Create KYCForm component with full integration</name>
  <files>client/src/components/forms/KYCForm.tsx</files>
  <action>
Create the complete KYC form that integrates all form infrastructure:

File: `client/src/components/forms/KYCForm.tsx`

**Step structure (per CONTEXT.md: "Logical groups of 3-5 related fields per step"):**
- Step 1: Personal Info (firstName, lastName, email, phone, address, pincode, city, state) - 8 fields
- Step 2: PAN & DOB (panNumber, dateOfBirth) - 2 fields
- Step 3: PED (hasPED toggle, conditions checkboxes, otherDescription) - conditional fields

**Key implementation requirements:**
1. Use `useForm` with `mode: 'onBlur'` and `reValidateMode: 'onBlur'` (per CONTEXT.md)
2. Use `useFormPersistence` hook for auto-save on blur (per CONTEXT.md)
3. Show `ResumePrompt` when returning with saved data (per CONTEXT.md)
4. Generate `submission_id` on final submit (per FORM-08)

```typescript
import { useState, useEffect, useCallback } from "react";
import { useForm } from "react-hook-form";
import { zodResolver } from "@hookform/resolvers/zod";
import { z } from "zod";

import { useFormPersistence } from "@/hooks/useFormPersistence";
import { generateSubmissionId } from "@/lib/submission-id";

import { MultiStepForm } from "./MultiStepForm";
import { FormStep } from "./FormStep";
import { StepProgress } from "./StepProgress";
import { ResumePrompt } from "./ResumePrompt";

import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Button } from "@/components/ui/button";
import { PANInput, PhoneInput, DateInput, PEDSelector, type PEDConditions } from "./fields";

import { personalInfoSchema, type PersonalInfoData } from "@/lib/form-schemas/personal-info";
import { panDobSchema, type PanDobData } from "@/lib/form-schemas/pan-dob";
import { pedSchema, type PedData } from "@/lib/form-schemas/ped";

// Combined form data type
const kycFormSchema = z.object({
  ...personalInfoSchema.shape,
  ...panDobSchema.shape,
  ...pedSchema.shape,
});

type KYCFormData = z.infer<typeof kycFormSchema>;

const defaultValues: KYCFormData = {
  firstName: "",
  lastName: "",
  email: "",
  phone: "",
  address: "",
  pincode: "",
  city: "",
  state: "",
  panNumber: "",
  dateOfBirth: "",
  hasPED: false,
  conditions: {
    diabetes: false,
    bloodPressure: false,
    heartAilments: false,
    asthma: false,
    thyroid: false,
    cancer: false,
    other: false,
  },
  otherDescription: "",
};

const FORM_ID = "kyc-form";
const STEP_TITLES = ["Personal Information", "Identity Verification", "Health Information"];

export interface KYCFormProps {
  onSubmit: (data: KYCFormData, submissionId: string) => void;
  className?: string;
}

export function KYCForm({ onSubmit, className }: KYCFormProps) {
  const [currentStep, setCurrentStep] = useState(0);
  const [showResumePrompt, setShowResumePrompt] = useState(false);

  const { getStoredData, saveData, clearData, hasStoredData } = useFormPersistence<KYCFormData>({
    formId: FORM_ID,
    defaultValues,
  });

  const {
    register,
    handleSubmit,
    formState: { errors },
    watch,
    setValue,
    getValues,
    trigger,
    reset,
  } = useForm<KYCFormData>({
    resolver: zodResolver(kycFormSchema),
    defaultValues,
    mode: "onBlur",
    reValidateMode: "onBlur",
  });

  // Check for stored data on mount
  useEffect(() => {
    if (hasStoredData()) {
      setShowResumePrompt(true);
    }
  }, [hasStoredData]);

  // Handle resume prompt
  const handleResume = useCallback(() => {
    const stored = getStoredData();
    if (stored) {
      reset(stored);
    }
    setShowResumePrompt(false);
  }, [getStoredData, reset]);

  const handleStartFresh = useCallback(() => {
    clearData();
    reset(defaultValues);
    setShowResumePrompt(false);
  }, [clearData, reset]);

  // Auto-save on blur (via form's onBlur events)
  const handleFieldBlur = useCallback(() => {
    const currentData = getValues();
    saveData(currentData);
  }, [getValues, saveData]);

  // Step navigation
  const goToNextStep = useCallback(async () => {
    // Validate current step fields before proceeding
    const stepFields = getStepFields(currentStep);
    const isValid = await trigger(stepFields);

    if (isValid) {
      setCurrentStep((prev) => Math.min(prev + 1, 2));
    }
  }, [currentStep, trigger]);

  const goToPrevStep = useCallback(() => {
    setCurrentStep((prev) => Math.max(prev - 1, 0));
  }, []);

  // Final submit
  const handleFinalSubmit = handleSubmit((data) => {
    const submissionId = generateSubmissionId();
    clearData(); // Clear persisted data on successful submit
    onSubmit(data, submissionId);
  });

  // Watch PED conditions for conditional rendering
  const hasPED = watch("hasPED");
  const conditions = watch("conditions");

  return (
    <div className={className}>
      <ResumePrompt
        open={showResumePrompt}
        onResume={handleResume}
        onStartFresh={handleStartFresh}
      />

      <StepProgress
        currentStep={currentStep}
        totalSteps={3}
        stepTitles={STEP_TITLES}
        className="mb-8"
      />

      <form onSubmit={handleFinalSubmit}>
        <MultiStepForm currentStep={currentStep}>
          {/* Step 1: Personal Information */}
          <FormStep
            title="Personal Information"
            description="Tell us about yourself so we can personalize your insurance options."
          >
            <div className="space-y-4">
              <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div className="space-y-2">
                  <Label htmlFor="firstName">First Name</Label>
                  <Input
                    id="firstName"
                    {...register("firstName")}
                    onBlur={(e) => {
                      register("firstName").onBlur(e);
                      handleFieldBlur();
                    }}
                    aria-invalid={!!errors.firstName}
                  />
                  {errors.firstName && (
                    <p className="text-xs text-destructive">{errors.firstName.message}</p>
                  )}
                </div>
                <div className="space-y-2">
                  <Label htmlFor="lastName">Last Name</Label>
                  <Input
                    id="lastName"
                    {...register("lastName")}
                    onBlur={(e) => {
                      register("lastName").onBlur(e);
                      handleFieldBlur();
                    }}
                    aria-invalid={!!errors.lastName}
                  />
                  {errors.lastName && (
                    <p className="text-xs text-destructive">{errors.lastName.message}</p>
                  )}
                </div>
              </div>

              <div className="space-y-2">
                <Label htmlFor="email">Email</Label>
                <Input
                  id="email"
                  type="email"
                  {...register("email")}
                  onBlur={(e) => {
                    register("email").onBlur(e);
                    handleFieldBlur();
                  }}
                  aria-invalid={!!errors.email}
                />
                {errors.email && (
                  <p className="text-xs text-destructive">{errors.email.message}</p>
                )}
              </div>

              <PhoneInput
                id="phone"
                value={watch("phone")}
                onChange={(value) => setValue("phone", value)}
                onBlur={handleFieldBlur}
                error={errors.phone?.message}
              />

              <div className="space-y-2">
                <Label htmlFor="address">Address</Label>
                <Input
                  id="address"
                  {...register("address")}
                  onBlur={(e) => {
                    register("address").onBlur(e);
                    handleFieldBlur();
                  }}
                  aria-invalid={!!errors.address}
                />
                {errors.address && (
                  <p className="text-xs text-destructive">{errors.address.message}</p>
                )}
              </div>

              <div className="grid grid-cols-1 sm:grid-cols-3 gap-4">
                <div className="space-y-2">
                  <Label htmlFor="pincode">Pincode</Label>
                  <Input
                    id="pincode"
                    {...register("pincode")}
                    onBlur={(e) => {
                      register("pincode").onBlur(e);
                      handleFieldBlur();
                    }}
                    maxLength={6}
                    aria-invalid={!!errors.pincode}
                  />
                  {errors.pincode && (
                    <p className="text-xs text-destructive">{errors.pincode.message}</p>
                  )}
                </div>
                <div className="space-y-2">
                  <Label htmlFor="city">City</Label>
                  <Input
                    id="city"
                    {...register("city")}
                    onBlur={(e) => {
                      register("city").onBlur(e);
                      handleFieldBlur();
                    }}
                    aria-invalid={!!errors.city}
                  />
                  {errors.city && (
                    <p className="text-xs text-destructive">{errors.city.message}</p>
                  )}
                </div>
                <div className="space-y-2">
                  <Label htmlFor="state">State</Label>
                  <Input
                    id="state"
                    {...register("state")}
                    onBlur={(e) => {
                      register("state").onBlur(e);
                      handleFieldBlur();
                    }}
                    aria-invalid={!!errors.state}
                  />
                  {errors.state && (
                    <p className="text-xs text-destructive">{errors.state.message}</p>
                  )}
                </div>
              </div>
            </div>
          </FormStep>

          {/* Step 2: PAN & DOB */}
          <FormStep
            title="Identity Verification"
            description="We need your PAN and date of birth for regulatory compliance."
          >
            <div className="space-y-4">
              <PANInput
                id="panNumber"
                value={watch("panNumber")}
                onChange={(value) => setValue("panNumber", value)}
                onBlur={handleFieldBlur}
                error={errors.panNumber?.message}
              />

              <DateInput
                id="dateOfBirth"
                value={watch("dateOfBirth")}
                onChange={(value) => setValue("dateOfBirth", value)}
                onBlur={handleFieldBlur}
                error={errors.dateOfBirth?.message}
              />
            </div>
          </FormStep>

          {/* Step 3: PED */}
          <FormStep
            title="Health Information"
            description="Let us know about any pre-existing conditions for accurate coverage."
          >
            <div className="space-y-4">
              <div className="flex items-center gap-3 p-4 rounded-lg border bg-muted/30">
                <input
                  type="checkbox"
                  id="hasPED"
                  {...register("hasPED")}
                  onChange={(e) => {
                    register("hasPED").onChange(e);
                    handleFieldBlur();
                  }}
                  className="w-4 h-4"
                />
                <Label htmlFor="hasPED" className="font-normal cursor-pointer">
                  I have pre-existing medical conditions
                </Label>
              </div>

              {hasPED && (
                <PEDSelector
                  conditions={conditions}
                  onConditionChange={(id, checked) => {
                    setValue(`conditions.${id}`, checked);
                    handleFieldBlur();
                  }}
                  otherDescription={watch("otherDescription")}
                  onOtherDescriptionChange={(value) => {
                    setValue("otherDescription", value);
                    handleFieldBlur();
                  }}
                  otherError={errors.otherDescription?.message}
                />
              )}
            </div>
          </FormStep>
        </MultiStepForm>

        {/* Navigation buttons */}
        <div className="flex justify-between mt-8">
          <Button
            type="button"
            variant="outline"
            onClick={goToPrevStep}
            disabled={currentStep === 0}
          >
            Previous
          </Button>

          {currentStep < 2 ? (
            <Button type="button" onClick={goToNextStep}>
              Next
            </Button>
          ) : (
            <Button type="submit">
              Submit
            </Button>
          )}
        </div>
      </form>
    </div>
  );
}

// Helper to get field names for each step (for validation)
function getStepFields(step: number): (keyof KYCFormData)[] {
  switch (step) {
    case 0:
      return ["firstName", "lastName", "email", "phone", "address", "pincode", "city", "state"];
    case 1:
      return ["panNumber", "dateOfBirth"];
    case 2:
      return ["hasPED", "conditions", "otherDescription"];
    default:
      return [];
  }
}
```
  </action>
  <verify>
1. File exists at client/src/components/forms/KYCForm.tsx
2. TypeScript compiles: `cd client && npx tsc --noEmit`
3. Imports resolve: useFormPersistence, all field components, all schemas
4. useForm is configured with mode: 'onBlur'
  </verify>
  <done>
- KYCForm has 3 steps: Personal Info, PAN/DOB, PED
- Navigation validates current step before proceeding
- Auto-saves to localStorage on every field blur
- Shows ResumePrompt when returning with saved data
- Generates submission_id on final submit via generateSubmissionId()
  </done>
</task>

<task type="auto">
  <name>Task 3: Create barrel export for forms</name>
  <files>client/src/components/forms/index.ts</files>
  <action>
Create barrel export for all form components:

File: `client/src/components/forms/index.ts`

```typescript
// Core multi-step form components
export { MultiStepForm, type MultiStepFormProps } from "./MultiStepForm";
export { FormStep, type FormStepProps } from "./FormStep";
export { StepProgress, type StepProgressProps } from "./StepProgress";
export { ResumePrompt, type ResumePromptProps } from "./ResumePrompt";

// Complete KYC form
export { KYCForm, type KYCFormProps } from "./KYCForm";

// Field components (re-export from fields/)
export {
  PANInput,
  PhoneInput,
  DateInput,
  PEDSelector,
  PED_CONDITIONS,
  type PANInputProps,
  type PhoneInputProps,
  type DateInputProps,
  type PEDSelectorProps,
  type PEDConditions,
  type PEDConditionId,
} from "./fields";
```
  </action>
  <verify>
1. File exists
2. All exports resolve: `cd client && npx tsc --noEmit`
3. Import works: `import { KYCForm, MultiStepForm, StepProgress } from "@/components/forms"`
  </verify>
  <done>
- Barrel export provides single import path for all form components
- Both core infrastructure and field components are exported
- Types are co-exported with components
  </done>
</task>

</tasks>

<verification>
1. `cd client && npx tsc --noEmit` passes with no errors
2. All form components exist in client/src/components/forms/
3. KYCForm uses useForm with mode: 'onBlur'
4. KYCForm uses useFormPersistence for auto-save
5. generateSubmissionId returns valid UUID v4
6. ResumePrompt appears when hasStoredData() returns true
</verification>

<success_criteria>
- KYCForm renders 3 steps with slide animations between them
- Step navigation validates current step fields before advancing
- Form auto-saves to localStorage on every blur event
- ResumePrompt appears when returning to partial form
- Submit button generates submission_id and calls onSubmit callback
- All components importable from "@/components/forms"
- TypeScript compilation passes
</success_criteria>

<output>
After completion, create `.planning/phases/02-form-infrastructure/02-04-SUMMARY.md`
</output>
