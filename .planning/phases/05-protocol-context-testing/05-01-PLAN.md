---
phase: 05-protocol-context-testing
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - docs/protocol/ondc/fis13/health/README.md
  - docs/protocol/ondc/fis13/health/schemas/build.yaml
  - docs/protocol/ondc/fis13/health/examples/select/select-request-personal-info.yaml
  - docs/protocol/ondc/fis13/health/examples/select/select-request-ped-info.yaml
  - docs/protocol/ondc/fis13/health/examples/on_select/on_select-request-personal-info.yaml
  - docs/protocol/ondc/fis13/health/examples/init/init-request-buyer-info.yaml
  - docs/protocol/ondc/fis13/health/examples/on_init/on_init-request.yaml
  - docs/protocol/ondc/fis13/health/examples/confirm/confirm-request.yaml
  - docs/protocol/ondc/fis13/health/examples/on_confirm/on_confirm-request.yaml
  - docs/protocol/ondc/fis13/health/examples/status/status-request.yaml
  - docs/protocol/ondc/fis13/health/examples/on_status/on_status-request.yaml
  - server/src/lib/ondc/schemas.ts
autonomous: true

must_haves:
  truths:
    - "Protocol reference docs exist in codebase at docs/protocol/ondc/fis13/health/"
    - "Example YAML files exist for select, init, confirm, status endpoints"
    - "Zod schemas are defined for ONDC context, error, quote, and all callback responses"
    - "Schemas use z.looseObject() for responses and z.object() for requests"
  artifacts:
    - path: "docs/protocol/ondc/fis13/health/README.md"
      provides: "Protocol documentation index with source version"
      contains: "draft-FIS13-health-2.0.1"
    - path: "docs/protocol/ondc/fis13/health/schemas/build.yaml"
      provides: "Full OpenAPI schema from ONDC"
      min_lines: 100
    - path: "server/src/lib/ondc/schemas.ts"
      provides: "Reusable Zod schemas for ONDC protocol"
      exports: ["ONDCContextSchema", "ONDCErrorSchema", "ONDCQuoteSchema"]
  key_links:
    - from: "docs/protocol/ondc/fis13/health/README.md"
      to: "GitHub ONDC-FIS-Specifications"
      via: "Source documentation"
      pattern: "ONDC-Official/ONDC-FIS-Specifications"
---

<objective>
Embed ONDC FIS13 health insurance protocol specifications in codebase and create reusable Zod schemas.

Purpose: Enable vibe-coding with immediate access to authoritative protocol examples and type-safe schema validation for all ONDC interactions.
Output: Protocol documentation directory with YAML examples, centralized Zod schema file with composable base schemas.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-protocol-context-testing/05-RESEARCH.md
@CLAUDE.md (section: Accessing ONDC FIS Specifications via GitHub API)
@server/src/trpc/routers/gateway.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fetch ONDC FIS13 Health Protocol Specs</name>
  <files>
    docs/protocol/ondc/fis13/health/README.md
    docs/protocol/ondc/fis13/health/schemas/build.yaml
    docs/protocol/ondc/fis13/health/examples/select/*.yaml
    docs/protocol/ondc/fis13/health/examples/on_select/*.yaml
    docs/protocol/ondc/fis13/health/examples/init/*.yaml
    docs/protocol/ondc/fis13/health/examples/on_init/*.yaml
    docs/protocol/ondc/fis13/health/examples/confirm/*.yaml
    docs/protocol/ondc/fis13/health/examples/on_confirm/*.yaml
    docs/protocol/ondc/fis13/health/examples/status/*.yaml
    docs/protocol/ondc/fis13/health/examples/on_status/*.yaml
  </files>
  <action>
    1. Create directory structure:
       ```
       mkdir -p docs/protocol/ondc/fis13/health/{schemas,examples/{select,on_select,init,on_init,confirm,on_confirm,status,on_status}}
       ```

    2. Fetch the full OpenAPI schema:
       ```bash
       gh api "repos/ONDC-Official/ONDC-FIS-Specifications/contents/api/build/build.yaml?ref=draft-FIS13-health-2.0.1" --jq '.content' | base64 -d > docs/protocol/ondc/fis13/health/schemas/build.yaml
       ```

    3. List and fetch select examples:
       ```bash
       gh api "repos/ONDC-Official/ONDC-FIS-Specifications/contents/api/components/examples/health-insurance/select?ref=draft-FIS13-health-2.0.1" --jq '.[].name'
       # For each file found, fetch it:
       gh api "repos/ONDC-Official/ONDC-FIS-Specifications/contents/api/components/examples/health-insurance/select/{filename}?ref=draft-FIS13-health-2.0.1" --jq '.content' | base64 -d > docs/protocol/ondc/fis13/health/examples/select/{filename}
       ```

    4. Repeat for on_select, init, on_init, confirm, on_confirm, status, on_status directories.

    5. Create README.md at docs/protocol/ondc/fis13/health/README.md:
       ```markdown
       # ONDC FIS13 Health Insurance Protocol Reference

       **Source:** ONDC-Official/ONDC-FIS-Specifications
       **Branch:** draft-FIS13-health-2.0.1
       **Fetched:** {current date}
       **Domain Code:** ONDC:FIS13

       ## Directory Structure

       - `schemas/build.yaml` - Full OpenAPI specification
       - `examples/` - Request/response examples by endpoint:
         - `select/` - Select request examples
         - `on_select/` - Select callback examples
         - `init/` - Init request examples (buyer info, medical info)
         - `on_init/` - Init callback with payment URL
         - `confirm/` - Confirm request after payment
         - `on_confirm/` - Policy confirmation with order ID
         - `status/` - Status query request
         - `on_status/` - Policy status with documents

       ## Updating Specs

       To refresh specs from upstream:
       ```bash
       gh api "repos/ONDC-Official/ONDC-FIS-Specifications/contents/api/build/build.yaml?ref=draft-FIS13-health-2.0.1" --jq '.content' | base64 -d > docs/protocol/ondc/fis13/health/schemas/build.yaml
       ```

       ## Usage

       Reference these YAML files for:
       - Understanding expected request/response structures
       - Debugging payload mismatches with BPPs
       - Implementing new ONDC endpoints
       ```

    Add comment at top of each YAML file: `# Source: ONDC-Official/ONDC-FIS-Specifications @ draft-FIS13-health-2.0.1`
  </action>
  <verify>
    - `ls docs/protocol/ondc/fis13/health/schemas/build.yaml` exists
    - `ls docs/protocol/ondc/fis13/health/examples/select/` has at least 1 file
    - `ls docs/protocol/ondc/fis13/health/examples/init/` has at least 1 file
    - `cat docs/protocol/ondc/fis13/health/README.md` contains "draft-FIS13-health-2.0.1"
  </verify>
  <done>Protocol documentation directory exists with OpenAPI schema and example YAML files for all endpoints</done>
</task>

<task type="auto">
  <name>Task 2: Create Centralized ONDC Zod Schemas</name>
  <files>server/src/lib/ondc/schemas.ts</files>
  <action>
    Create `server/src/lib/ondc/schemas.ts` with composable Zod schemas following research patterns:

    1. Base schemas (reusable across all endpoints):
       - `ONDCContextSchema` - Context object with domain, action, bap/bpp IDs, transaction_id, message_id, timestamp, ttl, version, location
       - `ONDCErrorSchema` - Error object with type, code, message
       - `DescriptorSchema` - Descriptor with name, short_desc, long_desc, images
       - `PriceSchema` - Price with currency and value
       - `ONDCQuoteSchema` - Quote with id, price, breakup array, ttl

    2. Response schemas (use z.looseObject for passthrough):
       - `OnSearchResponseSchema` - context, message with catalog, optional error
       - `OnSelectResponseSchema` - context, message with order (provider, items, quote, xinput), optional error
       - `OnInitResponseSchema` - context, message with order (provider, items, payments with url, quote), optional error
       - `OnConfirmResponseSchema` - context, message with order (id, provider, items, fulfillments, payments, quote), optional error
       - `OnStatusResponseSchema` - context, message with order (id, status, fulfillments, documents), optional error

    3. Request schemas (use strict z.object for what we send):
       - `SelectRequestSchema` - transactionId, bppId, bppUri, providerId, itemId, parentItemId, optional xinput fields, optional addOns
       - `InitRequestSchema` - transactionId, bppId, bppUri, providerId, itemId, parentItemId, xinputFormId, submissionId, customer info, amount
       - `ConfirmRequestSchema` - transactionId, bppId, bppUri, providerId, itemId, parentItemId, xinputFormId, submissionId, customer info, quoteId, amount, quoteBreakup
       - `StatusRequestSchema` - transactionId, orderId, bppId, bppUri

    Use Zod 4 patterns:
    - `z.looseObject()` for responses (allows extra fields from BPPs)
    - `z.object()` (strict by default) for requests (what we control)
    - Compose complex schemas from base schemas
    - Export all schemas and their inferred types

    Example structure:
    ```typescript
    import { z } from "zod";

    // Base schemas
    export const DescriptorSchema = z.looseObject({
      name: z.string(),
      short_desc: z.string().optional(),
      long_desc: z.string().optional(),
      images: z.array(z.looseObject({ url: z.string() })).optional(),
    });

    export const PriceSchema = z.looseObject({
      currency: z.string(),
      value: z.string(),
    });

    export const ONDCContextSchema = z.looseObject({
      domain: z.string().optional(),
      action: z.string().optional(),
      bap_id: z.string().optional(),
      bap_uri: z.string().optional(),
      bpp_id: z.string().optional(),
      bpp_uri: z.string().optional(),
      transaction_id: z.string().optional(),
      message_id: z.string().optional(),
      timestamp: z.string().optional(),
      ttl: z.string().optional(),
      version: z.string().optional(),
      location: z.looseObject({
        country: z.looseObject({ code: z.string() }).optional(),
        city: z.looseObject({ code: z.string() }).optional(),
      }).optional(),
    });

    export const ONDCErrorSchema = z.looseObject({
      type: z.string().optional(),
      code: z.string().optional(),
      message: z.string().optional(),
    });

    export const ONDCQuoteSchema = z.looseObject({
      id: z.string().optional(),
      price: PriceSchema.optional(),
      breakup: z.array(
        z.looseObject({
          title: z.string().optional(),
          price: PriceSchema.optional(),
        })
      ).optional(),
      ttl: z.string().optional(),
    });

    // Response schemas (loose - passthrough extra fields)
    export const OnSelectResponseSchema = z.looseObject({
      context: ONDCContextSchema.optional(),
      message: z.looseObject({
        order: z.looseObject({
          provider: z.looseObject({
            id: z.string().optional(),
            descriptor: DescriptorSchema.optional(),
          }).optional(),
          items: z.array(z.any()).optional(),
          quote: ONDCQuoteSchema.optional(),
          xinput: z.looseObject({
            form: z.looseObject({ url: z.string().optional(), id: z.string().optional() }).optional(),
          }).optional(),
        }).optional(),
      }).optional(),
      error: ONDCErrorSchema.optional(),
    });

    // Export inferred types
    export type ONDCContext = z.infer<typeof ONDCContextSchema>;
    export type ONDCError = z.infer<typeof ONDCErrorSchema>;
    export type ONDCQuote = z.infer<typeof ONDCQuoteSchema>;
    export type OnSelectResponse = z.infer<typeof OnSelectResponseSchema>;
    // ... etc
    ```

    NOTE: Do NOT modify gateway.ts to use these schemas in this plan. That's a separate refactoring task. This plan only creates the schemas file.
  </action>
  <verify>
    - `cat server/src/lib/ondc/schemas.ts` exists and has exports
    - Run `cd /Users/sudomakes/conductor/workspaces/ondc-vaatun/lisbon && pnpm exec tsc --noEmit --project server/tsconfig.json` passes without errors
  </verify>
  <done>Centralized Zod schemas file exists with ONDCContextSchema, ONDCErrorSchema, ONDCQuoteSchema and response schemas exported</done>
</task>

</tasks>

<verification>
1. Protocol docs exist: `ls -la docs/protocol/ondc/fis13/health/`
2. Schema file compiles: `pnpm exec tsc --noEmit --project server/tsconfig.json`
3. README contains source: `grep "draft-FIS13-health-2.0.1" docs/protocol/ondc/fis13/health/README.md`
4. Exports work: `grep "export const" server/src/lib/ondc/schemas.ts | head -10`
</verification>

<success_criteria>
- docs/protocol/ondc/fis13/health/ directory exists with README.md, schemas/, and examples/ subdirectories
- At least 1 example YAML file exists for each endpoint (select, on_select, init, on_init, confirm, on_confirm, status, on_status)
- server/src/lib/ondc/schemas.ts compiles without TypeScript errors
- Schema file exports ONDCContextSchema, ONDCErrorSchema, ONDCQuoteSchema
</success_criteria>

<output>
After completion, create `.planning/phases/05-protocol-context-testing/05-01-SUMMARY.md`
</output>
