---
phase: 05-protocol-context-testing
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - tests/api/gateway.spec.ts
autonomous: true

must_haves:
  truths:
    - "E2E tests verify init flow: init endpoint returns messageId, on_init stores payment URL, polling retrieves it"
    - "E2E tests verify confirm flow: confirm endpoint returns messageId, on_confirm stores orderId and policy, polling retrieves it"
    - "Tests handle BPP errors gracefully (503 is acceptable, not skipped)"
    - "Tests verify error responses are stored and retrievable"
  artifacts:
    - path: "tests/api/gateway.spec.ts"
      provides: "E2E tests for init and confirm flows"
      contains: "Init Flow Integration"
    - path: "tests/api/gateway.spec.ts"
      provides: "E2E tests for init and confirm flows"
      contains: "Confirm Flow Integration"
  key_links:
    - from: "tests/api/gateway.spec.ts"
      to: "/api/ondc/init"
      via: "request.post"
      pattern: 'request.post.*"/api/ondc/init"'
    - from: "tests/api/gateway.spec.ts"
      to: "/api/ondc/confirm"
      via: "request.post"
      pattern: 'request.post.*"/api/ondc/confirm"'
---

<objective>
Add comprehensive E2E tests for init and confirm flows in the gateway test file.

Purpose: Verify that init and confirm endpoints work correctly end-to-end: request triggers callback storage, polling retrieves results, and BPP errors are handled gracefully.
Output: Extended gateway.spec.ts with "Init Flow Integration" and "Confirm Flow Integration" test suites.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-protocol-context-testing/05-RESEARCH.md
@tests/api/gateway.spec.ts
@tests/api/polling.spec.ts
@server/src/trpc/routers/gateway.ts
@server/src/trpc/routers/results.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Init Flow E2E Tests</name>
  <files>tests/api/gateway.spec.ts</files>
  <action>
    Add a new test.describe block "Init Flow Integration" to tests/api/gateway.spec.ts with these tests:

    1. **"init endpoint returns messageId on success"**:
       - Generate unique transactionId using `test-init-${Date.now()}`
       - Call POST /api/ondc/init with all required fields:
         ```typescript
         {
           transactionId,
           bppId: "test-bpp.example.com",
           bppUri: "https://test-bpp.example.com/api/ondc",
           providerId: "provider-001",
           itemId: "item-001",
           parentItemId: "item-001",
           xinputFormId: "form-001",
           submissionId: "sub-001",
           customerName: "Test User",
           customerEmail: "test@example.com",
           customerPhone: "9876543210",
           amount: "15000.00",
         }
         ```
       - Accept 200 or 503 (BPP unreachable): `expect([200, 503].includes(response.status())).toBe(true)`
       - On 200: verify response has messageId and transactionId
       - On 503: early return (acceptable)

    2. **"on_init stores payment URL for polling"**:
       - Generate unique transactionId and messageId
       - POST /api/ondc/on_init with:
         ```typescript
         {
           context: {
             transaction_id: transactionId,
             message_id: messageId,
             bpp_id: "test-bpp",
             timestamp: new Date().toISOString(),
           },
           message: {
             order: {
               provider: { id: "P1" },
               items: [{ id: "I1" }],
               payments: [
                 {
                   url: "https://payment-gateway.example.com/pay/abc123",
                   type: "PRE-FULFILLMENT",
                   status: "NOT-PAID",
                 },
               ],
               quote: {
                 id: "Q1",
                 price: { currency: "INR", value: "15000.00" },
               },
             },
           },
         }
         ```
       - Verify returns 200 with ACK
       - GET /api/ondc/init-results?transaction_id={transactionId}&message_id={messageId}
       - Verify: found=true, hasResponse=true, paymentUrl contains expected URL

    3. **"on_init with BPP error stores error for polling"**:
       - Generate unique transactionId and messageId
       - POST /api/ondc/on_init with error object:
         ```typescript
         {
           context: { transaction_id: transactionId, message_id: messageId },
           error: {
             type: "DOMAIN-ERROR",
             code: "40002",
             message: "KYC validation failed",
           },
         }
         ```
       - Verify returns 200 with ACK
       - Poll for results
       - Verify: found=true, error object exists with code "40002"

    Follow existing test patterns in gateway.spec.ts:
    - Use `await response.text()` then parse JSON for better error messages
    - Include descriptive error messages in expects
    - No test.skip() for gateway errors
  </action>
  <verify>
    Run: `pnpm test:e2e -- tests/api/gateway.spec.ts --grep "Init Flow" --timeout=30000`
    All 3 tests should pass (or 503 early returns are acceptable)
  </verify>
  <done>Init Flow Integration tests exist and pass (or gracefully handle BPP unavailability)</done>
</task>

<task type="auto">
  <name>Task 2: Add Confirm Flow E2E Tests</name>
  <files>tests/api/gateway.spec.ts</files>
  <action>
    Add a new test.describe block "Confirm Flow Integration" to tests/api/gateway.spec.ts with these tests:

    1. **"confirm endpoint returns messageId on success"**:
       - Generate unique transactionId
       - Call POST /api/ondc/confirm with all required fields:
         ```typescript
         {
           transactionId,
           bppId: "test-bpp.example.com",
           bppUri: "https://test-bpp.example.com/api/ondc",
           providerId: "provider-001",
           itemId: "item-001",
           parentItemId: "item-001",
           xinputFormId: "form-001",
           submissionId: "sub-001",
           customerName: "Test User",
           customerEmail: "test@example.com",
           customerPhone: "9876543210",
           quoteId: "quote-001",
           amount: "15000.00",
           quoteBreakup: [
             { title: "Base Premium", price: { currency: "INR", value: "12000.00" } },
             { title: "GST", price: { currency: "INR", value: "3000.00" } },
           ],
         }
         ```
       - Accept 200 or 503
       - On 200: verify response has messageId and transactionId

    2. **"on_confirm stores order and policy for polling"**:
       - Generate unique transactionId, messageId, orderId
       - POST /api/ondc/on_confirm with:
         ```typescript
         {
           context: {
             transaction_id: transactionId,
             message_id: messageId,
             bpp_id: "test-bpp",
             timestamp: new Date().toISOString(),
           },
           message: {
             order: {
               id: orderId,
               status: "ACTIVE",
               provider: { id: "P1", descriptor: { name: "Test Insurance Co" } },
               items: [{ id: "I1", descriptor: { name: "Health Plan Premium" } }],
               fulfillments: [
                 {
                   id: "F1",
                   type: "POLICY",
                   state: { descriptor: { code: "GRANTED" } },
                 },
               ],
               payments: [
                 {
                   collected_by: "BPP",
                   status: "PAID",
                   type: "PRE-FULFILLMENT",
                 },
               ],
               quote: {
                 id: "Q1",
                 price: { currency: "INR", value: "15000.00" },
               },
             },
           },
         }
         ```
       - Verify returns 200 with ACK
       - GET /api/ondc/confirm-results?transaction_id={transactionId}&message_id={messageId}
       - Verify: found=true, hasResponse=true, orderId matches

    3. **"on_confirm with BPP error stores error for polling"**:
       - Generate unique transactionId and messageId
       - POST /api/ondc/on_confirm with error:
         ```typescript
         {
           context: { transaction_id: transactionId, message_id: messageId },
           error: {
             type: "DOMAIN-ERROR",
             code: "40003",
             message: "Payment verification failed",
           },
         }
         ```
       - Verify returns 200 with ACK
       - Poll for results
       - Verify: error object exists with code "40003"

    Follow same patterns as Init Flow tests.
  </action>
  <verify>
    Run: `pnpm test:e2e -- tests/api/gateway.spec.ts --grep "Confirm Flow" --timeout=30000`
    All 3 tests should pass
  </verify>
  <done>Confirm Flow Integration tests exist and pass</done>
</task>

</tasks>

<verification>
1. Test file has Init Flow section: `grep -c "Init Flow Integration" tests/api/gateway.spec.ts` returns 1
2. Test file has Confirm Flow section: `grep -c "Confirm Flow Integration" tests/api/gateway.spec.ts` returns 1
3. Init tests pass: `pnpm test:e2e -- tests/api/gateway.spec.ts --grep "Init Flow" --timeout=30000`
4. Confirm tests pass: `pnpm test:e2e -- tests/api/gateway.spec.ts --grep "Confirm Flow" --timeout=30000`
</verification>

<success_criteria>
- tests/api/gateway.spec.ts contains "Init Flow Integration" test.describe block with 3 tests
- tests/api/gateway.spec.ts contains "Confirm Flow Integration" test.describe block with 3 tests
- All new tests pass when run individually
- No test.skip() calls in new tests (503 handled via expect array)
</success_criteria>

<output>
After completion, create `.planning/phases/05-protocol-context-testing/05-02-SUMMARY.md`
</output>
