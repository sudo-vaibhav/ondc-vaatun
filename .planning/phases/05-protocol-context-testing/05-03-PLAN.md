---
phase: 05-protocol-context-testing
plan: 03
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - tests/api/gateway.spec.ts
autonomous: true

must_haves:
  truths:
    - "E2E tests verify status flow: status endpoint returns messageId, on_status stores policy details, polling retrieves it"
    - "E2E tests verify status flow handles policy documents"
    - "E2E tests verify select flow coverage is complete (request, callback, polling)"
    - "Tests handle BPP errors gracefully (503 is acceptable)"
  artifacts:
    - path: "tests/api/gateway.spec.ts"
      provides: "E2E tests for status flow"
      contains: "Status Flow Integration"
  key_links:
    - from: "tests/api/gateway.spec.ts"
      to: "/api/ondc/status"
      via: "request.post"
      pattern: 'request.post.*"/api/ondc/status"'
    - from: "tests/api/gateway.spec.ts"
      to: "/api/ondc/status-results"
      via: "request.get"
      pattern: 'request.get.*"/api/ondc/status-results"'
---

<objective>
Add comprehensive E2E tests for status flow and verify select flow coverage is complete.

Purpose: Verify status endpoint works correctly for policy retrieval, including document handling. Ensure select flow tests cover all integration scenarios.
Output: Extended gateway.spec.ts with "Status Flow Integration" test suite and verified select flow coverage.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-protocol-context-testing/05-RESEARCH.md
@tests/api/gateway.spec.ts
@tests/api/polling.spec.ts
@server/src/trpc/routers/gateway.ts
@server/src/trpc/routers/results.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Status Flow E2E Tests</name>
  <files>tests/api/gateway.spec.ts</files>
  <action>
    Add a new test.describe block "Status Flow Integration" to tests/api/gateway.spec.ts with these tests:

    1. **"status endpoint returns messageId on success"**:
       - Generate unique transactionId and orderId using `test-status-${Date.now()}` and `order-${Date.now()}`
       - Call POST /api/ondc/status with:
         ```typescript
         {
           transactionId,
           orderId,
           bppId: "test-bpp.example.com",
           bppUri: "https://test-bpp.example.com/api/ondc",
         }
         ```
       - Accept 200 or 503 (BPP unreachable)
       - On 200: verify response has messageId, transactionId, orderId

    2. **"on_status stores policy details for polling"**:
       - Generate unique transactionId and orderId
       - POST /api/ondc/on_status with full policy details:
         ```typescript
         {
           context: {
             transaction_id: transactionId,
             bpp_id: "test-bpp",
             timestamp: new Date().toISOString(),
           },
           message: {
             order: {
               id: orderId,
               status: "COMPLETE",
               provider: { id: "P1", descriptor: { name: "Test Insurance Co" } },
               items: [
                 {
                   id: "I1",
                   descriptor: { name: "Health Plan Premium" },
                 },
               ],
               fulfillments: [
                 {
                   id: "F1",
                   type: "POLICY",
                   state: { descriptor: { code: "GRANTED" } },
                   stops: [
                     {
                       time: {
                         range: {
                           start: "2026-01-01T00:00:00Z",
                           end: "2026-12-31T23:59:59Z",
                         },
                       },
                     },
                   ],
                 },
               ],
               documents: [
                 {
                   descriptor: { code: "policy-doc" },
                   url: "https://test-insurance.example.com/policies/POL123.pdf",
                   mime_type: "application/pdf",
                 },
               ],
             },
           },
         }
         ```
       - Verify returns 200 with ACK
       - GET /api/ondc/status-results?order_id={orderId}
       - Verify: found=true, hasResponse=true, policy object contains expected fields

    3. **"on_status stores policy with validity dates"**:
       - Test that fulfillment validity dates are captured
       - Verify polling returns validFrom and validTo (or equivalent structure from raw response)

    4. **"on_status with BPP error stores error for polling"**:
       - Generate unique orderId
       - POST /api/ondc/on_status with error:
         ```typescript
         {
           context: { bpp_id: "test-bpp", timestamp: new Date().toISOString() },
           message: { order: { id: orderId } },
           error: {
             type: "DOMAIN-ERROR",
             code: "40004",
             message: "Order not found",
           },
         }
         ```
       - Verify returns 200 with ACK
       - Poll for results using order_id
       - Verify: error object exists with code "40004"

    Follow same patterns as Init and Confirm tests.
  </action>
  <verify>
    Run: `pnpm test:e2e -- tests/api/gateway.spec.ts --grep "Status Flow" --timeout=30000`
    All 4 tests should pass
  </verify>
  <done>Status Flow Integration tests exist and pass</done>
</task>

<task type="auto">
  <name>Task 2: Verify Select Flow Test Coverage</name>
  <files>tests/api/gateway.spec.ts</files>
  <action>
    Review and enhance the existing "Select Integration Flow" tests in tests/api/gateway.spec.ts to ensure complete coverage:

    1. **Verify existing tests cover**:
       - select endpoint returns messageId
       - on_select callback stores response
       - polling retrieves quote data
       - BPP error handling

    2. **Add missing test if needed: "select with add-ons stores and retrieves add-on data"**:
       If not already covered, add a test that:
       - Calls select with addOns array
       - Simulates on_select callback with add-on pricing in quote breakup
       - Verifies polling returns the add-on details

    3. **Verify test naming consistency**:
       - All describe blocks should use "Flow Integration" suffix for consistency
       - Ensure the existing "Select Integration Flow" is renamed to "Select Flow Integration" for consistency with Init, Confirm, Status

    Review the existing tests and determine if enhancements are needed. If the existing tests already cover:
    - Happy path (select -> on_select -> poll)
    - Error path (on_select with error -> poll -> error visible)
    - Basic validation (400 on missing fields)

    Then mark this task as complete with existing coverage verified.

    The key requirement (TEST-01) is:
    > E2E tests verify select flow (select -> on_select -> quote display)

    This is already covered by:
    - "on_select callback stores response for polling" test
    - "getSelectResults returns error info when BPP returns error" test

    If coverage is complete, document what tests satisfy TEST-01 in the summary.
  </action>
  <verify>
    Run: `pnpm test:e2e -- tests/api/gateway.spec.ts --grep "Select" --timeout=30000`
    All select-related tests should pass
  </verify>
  <done>Select flow E2E test coverage verified complete (or enhanced if gaps found)</done>
</task>

</tasks>

<verification>
1. Test file has Status Flow section: `grep -c "Status Flow Integration" tests/api/gateway.spec.ts` returns 1
2. Status tests pass: `pnpm test:e2e -- tests/api/gateway.spec.ts --grep "Status Flow" --timeout=30000`
3. Select tests pass: `pnpm test:e2e -- tests/api/gateway.spec.ts --grep "Select" --timeout=30000`
4. Full gateway tests pass: `pnpm test:e2e -- tests/api/gateway.spec.ts --timeout=60000`
</verification>

<success_criteria>
- tests/api/gateway.spec.ts contains "Status Flow Integration" test.describe block with 4 tests
- All status flow tests pass when run individually
- Select flow tests verified to cover: request -> callback -> polling -> error handling
- No test.skip() calls in new tests
- All gateway tests pass when running the full test file
</success_criteria>

<output>
After completion, create `.planning/phases/05-protocol-context-testing/05-03-SUMMARY.md`
</output>
