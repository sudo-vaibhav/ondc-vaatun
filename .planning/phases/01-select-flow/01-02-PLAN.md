---
phase: 01-select-flow
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - client/src/components/quote/AddOnSelector.tsx
  - client/src/components/quote/TermsCollapsible.tsx
  - client/src/routes/quote/$transactionId/$messageId.tsx

autonomous: true

must_haves:
  truths:
    - "User can toggle add-ons on/off"
    - "Add-on prices update total dynamically"
    - "Terms & conditions section is collapsible"
    - "Quote page polls for BPP response"
    - "Loading state shows while waiting for quote"
    - "Error state displays when BPP returns error"
  artifacts:
    - path: "client/src/components/quote/AddOnSelector.tsx"
      provides: "Add-on toggles with price calculation"
      min_lines: 60
    - path: "client/src/components/quote/TermsCollapsible.tsx"
      provides: "Collapsible terms section"
      min_lines: 30
    - path: "client/src/routes/quote/$transactionId/$messageId.tsx"
      provides: "Complete quote page with polling"
      min_lines: 100
  key_links:
    - from: "client/src/routes/quote/$transactionId/$messageId.tsx"
      to: "trpc.results.getSelectResults"
      via: "useQuery with refetchInterval"
      pattern: "refetchInterval.*hasResponse"
    - from: "client/src/components/quote/AddOnSelector.tsx"
      to: "Switch component"
      via: "toggle state management"
      pattern: "useState.*Set.*Switch"
---

<objective>
Create AddOnSelector and TermsCollapsible components, then wire everything together in the quote page with proper polling, loading, and error states.

Purpose: Complete the quote display page with all user-facing features specified in CONTEXT.md.
Output: Fully functional quote page that polls for results, displays coverage, allows add-on selection, and shows collapsible T&C.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-select-flow/CONTEXT.md
@.planning/phases/01-select-flow/01-RESEARCH.md

@client/src/components/ui/switch.tsx
@client/src/components/ui/collapsible.tsx
@client/src/components/quote/QuoteHeader.tsx
@client/src/components/quote/CoverageDetails.tsx
@client/src/components/quote/QuoteBreakdown.tsx
@client/src/routes/quote/$transactionId/$messageId.tsx
@server/src/lib/select-store.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create AddOnSelector component</name>
  <files>client/src/components/quote/AddOnSelector.tsx</files>
  <action>
Create `client/src/components/quote/AddOnSelector.tsx` with:

1. Props interface:
```typescript
interface AddOn {
  id: string;
  descriptor?: { name?: string; code?: string };
  price?: { currency: string; value: string };
  quantity?: { selected?: { count: number } };
}

interface AddOnSelectorProps {
  addOns: AddOn[];
  onSelectionChange?: (selectedIds: string[], totalPrice: number) => void;
}
```

2. State management:
- Use `useState<Set<string>>` for selected add-on IDs (all unselected by default per CONTEXT.md)
- Use `useMemo` to calculate total add-on price from selected IDs

3. UI (per CONTEXT.md decisions):
- Each add-on in a Card with flex layout
- Left side: Add-on name and description (if available)
- Right side: Price and Switch toggle
- Show per-add-on price inline
- Show total add-ons price at bottom when > 0

4. Event handling:
- Toggle function adds/removes from Set
- Call onSelectionChange callback with updated selection

Use Switch component from @/components/ui/switch.
Use Card, Label from existing UI components.
Format prices with Intl.NumberFormat (INR, en-IN locale).
  </action>
  <verify>
- File exists at `client/src/components/quote/AddOnSelector.tsx`
- Exports `AddOnSelector` function component
- Uses Switch component for toggles
- Has useMemo for price calculation
- `pnpm lint` passes
  </verify>
  <done>AddOnSelector component allows toggling add-ons with dynamic price updates</done>
</task>

<task type="auto">
  <name>Task 2: Create TermsCollapsible component</name>
  <files>client/src/components/quote/TermsCollapsible.tsx</files>
  <action>
Create `client/src/components/quote/TermsCollapsible.tsx` with:

1. Props interface:
```typescript
interface TermsCollapsibleProps {
  terms?: string;  // Long description from provider if available
}
```

2. UI structure:
- Use Collapsible from @/components/ui/collapsible
- CollapsibleTrigger shows "Terms & Conditions" with chevron icon
- CollapsibleContent shows terms text
- Default state: collapsed (closed)

3. Content:
- If `terms` prop provided, display it
- If no terms provided, show placeholder: "Terms and conditions apply. Full policy terms will be provided after application submission."

4. Styling:
- Use Card container
- Trigger has hover state, cursor-pointer
- ChevronDown icon rotates when open (use CSS transform or data attribute)
  </action>
  <verify>
- File exists at `client/src/components/quote/TermsCollapsible.tsx`
- Exports `TermsCollapsible` function component
- Uses Collapsible component
- Has default placeholder text
- `pnpm lint` passes
  </verify>
  <done>TermsCollapsible component shows expandable terms section</done>
</task>

<task type="auto">
  <name>Task 3: Wire up complete quote page with polling</name>
  <files>client/src/routes/quote/$transactionId/$messageId.tsx</files>
  <action>
Rewrite `client/src/routes/quote/$transactionId/$messageId.tsx` with:

1. Polling configuration (from RESEARCH.md):
```typescript
const { data, isLoading, error } = trpc.results.getSelectResults.useQuery(
  { transactionId, messageId },
  {
    refetchInterval: (data) => {
      // Stop polling when response received or error occurs
      if (data?.hasResponse || data?.error) return false;
      return 2000; // Poll every 2 seconds
    },
    refetchIntervalInBackground: false,
  }
);
```

2. Loading state (per CONTEXT.md):
- Use Loader2 icon with animate-spin (Captain Otter images deferred)
- Center in viewport
- Message: "Fetching your personalized quote..."
- No cancel button (per CONTEXT.md decision)

3. Error state (per CONTEXT.md):
- Show error icon
- Display technical error details
- Retry link (reload page)
- "Back to Results" link using `Link` from TanStack Router

4. Success state layout:
- Back button at top (Link to /health/$searchId with searchId = transactionId)
- QuoteHeader component (provider + premium)
- CoverageDetails component (tags grid)
- QuoteBreakdown component (existing, price breakdown)
- AddOnSelector component (if item.add_ons exists)
- TermsCollapsible component
- "Proceed to Application" button (disabled for Phase 1, Phase 2 handles forms)

5. Imports:
```typescript
import { QuoteHeader } from "@/components/quote/QuoteHeader";
import { CoverageDetails } from "@/components/quote/CoverageDetails";
import { AddOnSelector } from "@/components/quote/AddOnSelector";
import { TermsCollapsible } from "@/components/quote/TermsCollapsible";
import QuoteBreakdown from "@/components/quote/QuoteBreakdown";
```

6. State for add-on selection (local useState, not sent to backend yet):
```typescript
const [selectedAddOns, setSelectedAddOns] = useState<string[]>([]);
const [addOnTotal, setAddOnTotal] = useState(0);
```
  </action>
  <verify>
- File updated at `client/src/routes/quote/$transactionId/$messageId.tsx`
- Has refetchInterval with stop condition
- Loading state displays while !hasResponse
- Error state handles data?.error
- All quote components rendered
- Back link points to /health/$transactionId (using transactionId as searchId)
- `pnpm lint` passes
- `pnpm build` passes
  </verify>
  <done>Quote page polls for results and displays complete quote with all components</done>
</task>

</tasks>

<verification>
1. AddOnSelector exists: `ls client/src/components/quote/AddOnSelector.tsx`
2. TermsCollapsible exists: `ls client/src/components/quote/TermsCollapsible.tsx`
3. Quote page updated: `grep -l "refetchInterval" client/src/routes/quote/\$transactionId/\$messageId.tsx`
4. Lint passes: `pnpm lint`
5. Build passes: `pnpm build`
6. Manual test (if dev server running):
   - Navigate to a quote page URL
   - Verify loading state appears
   - Verify quote displays when response arrives (or error if BPP fails)
</verification>

<success_criteria>
- AddOnSelector toggles add-ons and calculates total price
- TermsCollapsible expands/collapses
- Quote page polls with smart refetchInterval
- Loading state shows Loader2 spinner
- Error state shows error details with retry option
- All components render in correct layout
- Back navigation works to search results
</success_criteria>

<output>
After completion, create `.planning/phases/01-select-flow/01-02-SUMMARY.md`
</output>
