---
phase: 03-async-callback-correlation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - server/src/lib/trace-context-store.ts
  - server/src/lib/search-store.ts
autonomous: true

must_haves:
  truths:
    - "serializeTraceContext() returns a W3C traceparent string when called inside an active span"
    - "serializeTraceContext() returns undefined when no active span exists"
    - "restoreTraceContext() reconstructs a valid SpanContext from a stored traceparent string"
    - "restoreTraceContext() returns undefined when given undefined or invalid input"
    - "createLinkedSpanOptions() produces SpanOptions with a links array referencing the original span"
    - "SearchEntry interface includes optional traceparent field"
    - "createSearchEntry() accepts and stores traceparent in the same Redis write"
    - "Search entry TTL is 30 minutes to catch late-arriving BPP callbacks"
  artifacts:
    - path: "server/src/lib/trace-context-store.ts"
      provides: "Trace context serialization/restoration utilities"
      exports: ["serializeTraceContext", "restoreTraceContext", "createLinkedSpanOptions"]
    - path: "server/src/lib/search-store.ts"
      provides: "SearchEntry with traceparent field and extended TTL"
      contains: "traceparent"
  key_links:
    - from: "server/src/lib/trace-context-store.ts"
      to: "@opentelemetry/api"
      via: "propagation.inject/extract, trace.getSpanContext"
      pattern: "propagation\\.(inject|extract)"
    - from: "server/src/lib/search-store.ts"
      to: "server/src/infra/key-value/redis"
      via: "kv.set with 30-minute TTL"
      pattern: "30 \\* 60 \\* 1000"
---

<objective>
Create the trace context utility module and extend the search store to support traceparent storage.

Purpose: Provide reusable utilities for serializing/restoring W3C trace context (Phase 4 reuses these for select/init/confirm) and prepare the search entry data model to carry trace context alongside existing transaction metadata.

Output: Two files — a new `trace-context-store.ts` utility and a modified `search-store.ts` with traceparent support and extended TTL.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-async-callback-correlation/03-RESEARCH.md
@.planning/phases/03-async-callback-correlation/CONTEXT.md
@server/src/lib/search-store.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create trace-context-store.ts utility module</name>
  <files>server/src/lib/trace-context-store.ts</files>
  <action>
Create a new file `server/src/lib/trace-context-store.ts` with three exported functions:

1. **serializeTraceContext()**: Returns `string | undefined`
   - Import `context, propagation, trace` from `@opentelemetry/api`
   - Create an empty carrier object: `const carrier: Record<string, string> = {}`
   - Call `propagation.inject(context.active(), carrier)`
   - Return `carrier.traceparent` (will be undefined if no active span)
   - Do NOT manually construct traceparent strings — let the propagation API handle it

2. **restoreTraceContext(traceparent)**: Takes `string | undefined`, returns `SpanContext | undefined`
   - If traceparent is falsy, return undefined
   - Create carrier: `{ traceparent }`
   - Call `propagation.extract(context.active(), carrier)` to get extracted context
   - Call `trace.getSpanContext(extractedContext)` to get SpanContext
   - Return the SpanContext (which has `isRemote: true` set automatically by the propagator)

3. **createLinkedSpanOptions(originalSpanContext, baseOptions)**: Takes `SpanContext | undefined` and `SpanOptions`, returns `SpanOptions`
   - Import `SpanOptions` type from `@opentelemetry/api`
   - Spread baseOptions
   - Set `links` array: if originalSpanContext is defined, include one link with `context: originalSpanContext` and attributes `{ "link.type": "async_callback" }`. If undefined, set links to empty array.
   - Return the merged SpanOptions

Use proper TypeScript types. Import `type SpanContext, type SpanOptions` for type-only imports.
  </action>
  <verify>
Run `npx tsc --noEmit` from the server directory to verify the file compiles without type errors. Verify the file exports the three functions by checking with grep.
  </verify>
  <done>
trace-context-store.ts exists with three exported functions (serializeTraceContext, restoreTraceContext, createLinkedSpanOptions) that compile without errors. Functions use OpenTelemetry's propagation API — no manual traceparent parsing.
  </done>
</task>

<task type="auto">
  <name>Task 2: Extend SearchEntry with traceparent and 30-minute TTL</name>
  <files>server/src/lib/search-store.ts</files>
  <action>
Modify `server/src/lib/search-store.ts` with two changes:

1. **Add traceparent to SearchEntry interface:**
   - Add `traceparent?: string;` field to the `SearchEntry` interface (after `ttlExpiresAt`)
   - This is an optional field — entries created before this change will still work

2. **Add traceparent parameter to createSearchEntry():**
   - Add an optional `traceparent?: string` parameter as the last argument to `createSearchEntry()`
   - Include `traceparent` in the entry object literal (alongside existing fields)
   - This changes the function signature but is backward-compatible (parameter is optional)

3. **Extend DEFAULT_STORE_TTL_MS from 10 minutes to 30 minutes:**
   - Change `const DEFAULT_STORE_TTL_MS = 10 * 60 * 1000;` to `const DEFAULT_STORE_TTL_MS = 30 * 60 * 1000;`
   - This is the CONTEXT.md decision: 30-minute TTL to catch late-arriving BPP callbacks
   - Note: This affects ALL search entries and their responses (same TTL for simplicity)

Do NOT modify `addSearchResponse()`, `getSearchEntry()`, `getSearchResults()`, or any other existing functions. They continue to work unchanged — `traceparent` is just an extra field on the existing entry object.
  </action>
  <verify>
Run `npx tsc --noEmit` from the server directory to verify no type errors. Verify the SearchEntry interface includes traceparent with grep. Verify DEFAULT_STORE_TTL_MS is 30 minutes.
  </verify>
  <done>
SearchEntry has `traceparent?: string` field. createSearchEntry() accepts optional traceparent parameter. DEFAULT_STORE_TTL_MS is 30 * 60 * 1000 (30 minutes). All existing code continues to compile — change is backward-compatible.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors from server directory
2. `server/src/lib/trace-context-store.ts` exists and exports serializeTraceContext, restoreTraceContext, createLinkedSpanOptions
3. `server/src/lib/search-store.ts` SearchEntry interface has traceparent field
4. createSearchEntry function signature includes traceparent parameter
5. DEFAULT_STORE_TTL_MS equals 30 * 60 * 1000
</verification>

<success_criteria>
- Utility module compiles and exports three functions using OpenTelemetry propagation API
- SearchEntry data model extended with traceparent field (backward-compatible)
- Search entry TTL extended to 30 minutes per CONTEXT.md decision
- No existing tests broken by these changes
</success_criteria>

<output>
After completion, create `.planning/phases/03-async-callback-correlation/03-01-SUMMARY.md`
</output>
