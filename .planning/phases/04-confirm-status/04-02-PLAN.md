---
phase: 04-confirm-status
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - server/src/trpc/routers/gateway.ts
  - server/src/trpc/routers/results.ts
  - server/public/openapi.json
autonomous: true

must_haves:
  truths:
    - "confirm request sends ONDC-compliant payload to BPP"
    - "on_confirm callback stores response with orderId extraction"
    - "status request sends orderId-only payload to BPP"
    - "on_status callback stores policy document"
    - "getConfirmResults query returns confirm state"
    - "getStatusResults query returns status with policy document"
  artifacts:
    - path: "server/src/trpc/routers/gateway.ts"
      provides: "confirm, onConfirm, status, onStatus procedures"
      exports: ["gatewayRouter"]
    - path: "server/src/trpc/routers/results.ts"
      provides: "getConfirmResults, getStatusResults queries"
      exports: ["resultsRouter"]
    - path: "server/public/openapi.json"
      provides: "API documentation for new endpoints"
      contains: "/api/trpc/gateway.confirm"
  key_links:
    - from: "gateway.ts"
      to: "confirm-store.ts"
      via: "createConfirmEntry, addConfirmResponse imports"
      pattern: "from.*confirm-store"
    - from: "gateway.ts"
      to: "status-store.ts"
      via: "createStatusEntry, addStatusResponse imports"
      pattern: "from.*status-store"
    - from: "results.ts"
      to: "confirm-store.ts and status-store.ts"
      via: "getConfirmResult, getStatusResult imports"
      pattern: "getConfirmResult|getStatusResult"
---

<objective>
Add confirm/onConfirm/status/onStatus gateway procedures and results queries.

Purpose: Enable the ONDC FIS13 confirm and status flows by adding tRPC procedures that send requests to BPP and handle callbacks.

Output: Gateway router with 4 new procedures, results router with 2 new queries, updated OpenAPI docs.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-confirm-status/04-CONTEXT.md
@.planning/phases/04-confirm-status/04-RESEARCH.md

# Pattern reference - follow init/onInit exactly
@server/src/trpc/routers/gateway.ts
@server/src/trpc/routers/results.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add confirm and onConfirm procedures to gateway router</name>
  <files>server/src/trpc/routers/gateway.ts</files>
  <action>
Add confirm and onConfirm procedures to gatewayRouter, following init/onInit pattern:

1. Add imports at top:
   ```typescript
   import { addConfirmResponse, createConfirmEntry } from "../../lib/confirm-store";
   ```

2. Add `confirm` procedure (mutation):
   Input schema (z.object):
   - transactionId: z.uuid()
   - messageId: z.uuid().optional() (for idempotent retries)
   - bppId: z.string()
   - bppUri: z.url()
   - providerId: z.string()
   - itemId: z.string()
   - parentItemId: z.string()
   - xinputFormId: z.string()
   - submissionId: z.string()
   - addOns: z.array(z.object({ id: z.string(), quantity: z.number().int().positive() })).optional()
   - customerName: z.string()
   - customerEmail: z.string().email()
   - customerPhone: z.string()
   - quoteId: z.string()
   - amount: z.string()
   - quoteBreakup: z.array(z.object({ title: z.string(), price: z.object({ currency: z.string(), value: z.string() }) })).optional()

   Implementation:
   - Generate messageId if not provided (uuidv7())
   - Call createConfirmEntry with transactionId, messageId, itemId, providerId, bppId, bppUri, quoteId, amount
   - Build confirm payload per ONDC FIS13 spec (see RESEARCH.md Pattern 1):
     - context.action = "confirm"
     - context.ttl = "P24H"
     - message.order with provider, items (with xinput form_response), fulfillments (with customer), payments, quote
   - Send to BPP confirm URL
   - Return response with transactionId and messageId

3. Add `onConfirm` procedure (mutation):
   Input schema: Same pattern as onInit (context passthrough, message any, error optional)

   Implementation:
   - Extract transactionId, messageId from context
   - Extract orderId from message.order.id
   - Call addConfirmResponse(kv, transactionId, messageId, orderId, input)
   - Return ACK response

Key confirm payload differences from init (per RESEARCH.md):
- Includes quote object with id, price, breakup, ttl
- fulfillments has id: "F1" and type: "POLICY"
- Uses customer info in fulfillments, not just order level
  </action>
  <verify>TypeScript compiles. Check gateway.ts has confirm and onConfirm procedures.</verify>
  <done>confirm sends ONDC payload, onConfirm stores response with orderId.</done>
</task>

<task type="auto">
  <name>Task 2: Add status and onStatus procedures to gateway router</name>
  <files>server/src/trpc/routers/gateway.ts</files>
  <action>
Add status and onStatus procedures to gatewayRouter:

1. Add imports at top:
   ```typescript
   import { addStatusResponse, createStatusEntry } from "../../lib/status-store";
   ```

2. Add `status` procedure (mutation):
   Input schema (z.object):
   - transactionId: z.uuid()
   - orderId: z.string()
   - bppId: z.string()
   - bppUri: z.url()

   Implementation:
   - Generate messageId (uuidv7())
   - Call createStatusEntry with orderId, transactionId, bppId, bppUri
   - Build status payload (MUCH SIMPLER than confirm - see RESEARCH.md Pattern 3):
     - context.action = "status"
     - context.ttl = "PT10M" (shorter than confirm)
     - message.order_id = orderId (JUST the order ID, nothing else!)
   - Send to BPP status URL
   - Return response with transactionId, orderId, messageId

3. Add `onStatus` procedure (mutation):
   Input schema: Same pattern as onConfirm (context passthrough, message any, error optional)

   Implementation:
   - Extract orderId from message.order.id
   - Call addStatusResponse(kv, orderId, input)
   - Return ACK response

Key status differences from confirm (per RESEARCH.md):
- ttl is "PT10M" not "P24H"
- message only contains order_id, nothing else
- Response may include documents array with policy PDF URL
  </action>
  <verify>TypeScript compiles. Check gateway.ts has status and onStatus procedures.</verify>
  <done>status sends simple orderId request, onStatus stores policy document.</done>
</task>

<task type="auto">
  <name>Task 3: Add results queries and update OpenAPI docs</name>
  <files>server/src/trpc/routers/results.ts, server/public/openapi.json</files>
  <action>
1. Add to results.ts:

   Add imports:
   ```typescript
   import { getConfirmResult } from "../../lib/confirm-store";
   import { getStatusResult } from "../../lib/status-store";
   ```

   Add getConfirmResults query:
   - Input: { transactionId: z.string(), messageId: z.string() }
   - Implementation: Call getConfirmResult(kv, transactionId, messageId)
   - Return result with found check

   Add getStatusResults query:
   - Input: { orderId: z.string() }
   - Implementation: Call getStatusResult(kv, orderId)
   - Return result with found check

2. Update server/public/openapi.json:

   Add paths for new endpoints:
   - POST /api/trpc/gateway.confirm - "Send confirm request to BPP"
   - POST /api/trpc/gateway.onConfirm - "Handle on_confirm callback from BPP"
   - POST /api/trpc/gateway.status - "Send status request to BPP"
   - POST /api/trpc/gateway.onStatus - "Handle on_status callback from BPP"
   - GET /api/trpc/results.getConfirmResults - "Get confirm polling results"
   - GET /api/trpc/results.getStatusResults - "Get status polling results"

   Follow existing OpenAPI patterns in the file for request/response schemas.
  </action>
  <verify>TypeScript compiles. results.ts exports getConfirmResults and getStatusResults. OpenAPI has new paths.</verify>
  <done>Results queries work with stores, OpenAPI documented.</done>
</task>

</tasks>

<verification>
1. TypeScript compilation: `cd server && pnpm exec tsc --noEmit`
2. Gateway router exports all 4 new procedures
3. Results router exports 2 new queries
4. OpenAPI docs at /api/reference show new endpoints
</verification>

<success_criteria>
- confirm procedure sends ONDC-compliant payload with quote object
- status procedure sends minimal orderId-only payload
- on_confirm extracts and stores orderId
- on_status stores policy document
- Results queries return expected fields
- OpenAPI documentation updated
</success_criteria>

<output>
After completion, create `.planning/phases/04-confirm-status/04-02-SUMMARY.md`
</output>
