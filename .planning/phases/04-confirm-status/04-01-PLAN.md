---
phase: 04-confirm-status
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - server/src/infra/key-value/redis/key-formatter.ts
  - server/src/lib/confirm-store.ts
  - server/src/lib/status-store.ts
autonomous: true

must_haves:
  truths:
    - "Confirm entries can be stored and retrieved by transactionId+messageId"
    - "Status entries can be stored and retrieved by orderId"
    - "on_confirm responses are stored with orderId extraction"
    - "on_status responses are stored with policy document extraction"
  artifacts:
    - path: "server/src/lib/confirm-store.ts"
      provides: "Confirm transaction state store"
      exports: ["createConfirmEntry", "addConfirmResponse", "getConfirmResult", "ConfirmEntry", "ConfirmResult", "OnConfirmResponse"]
    - path: "server/src/lib/status-store.ts"
      provides: "Status polling state store"
      exports: ["createStatusEntry", "addStatusResponse", "getStatusResult", "StatusEntry", "StatusResult", "OnStatusResponse"]
    - path: "server/src/infra/key-value/redis/key-formatter.ts"
      provides: "Redis key formatting for confirm and status"
      exports: ["confirmKey", "confirmChannel", "statusKey", "statusChannel"]
  key_links:
    - from: "server/src/lib/confirm-store.ts"
      to: "key-formatter.ts"
      via: "keyFormatter.confirm and keyFormatter.confirmChannel"
      pattern: "keyFormatter\\.confirm"
    - from: "server/src/lib/status-store.ts"
      to: "key-formatter.ts"
      via: "keyFormatter.status and keyFormatter.statusChannel"
      pattern: "keyFormatter\\.status"
---

<objective>
Create Redis-backed stores for confirm and status transaction state management.

Purpose: Enable confirm/on_confirm and status/on_status flows by providing persistent state storage that follows the established init-store pattern.

Output: confirm-store.ts and status-store.ts with CRUD operations, plus key-formatter updates.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-confirm-status/04-CONTEXT.md
@.planning/phases/04-confirm-status/04-RESEARCH.md

# Pattern reference - copy this structure exactly
@server/src/lib/init-store.ts
@server/src/infra/key-value/redis/key-formatter.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add confirm and status key formatters</name>
  <files>server/src/infra/key-value/redis/key-formatter.ts</files>
  <action>
Add confirm and status key prefixes and formatter functions to key-formatter.ts:

1. Add to KEY_PREFIXES:
   - CONFIRM: "confirm"
   - STATUS: "status"

2. Add confirmKey function (same pattern as initKey):
   - Takes transactionId and messageId
   - Returns `confirm:${transactionId}:${messageId}`

3. Add confirmChannel function:
   - Takes transactionId and messageId
   - Returns `confirm:${transactionId}:${messageId}:updates`

4. Add statusKey function (DIFFERENT - keyed by orderId only):
   - Takes orderId only
   - Returns `status:${orderId}`

5. Add statusChannel function:
   - Takes orderId only
   - Returns `status:${orderId}:updates`

6. Export all new functions in keyFormatter object

Key difference from init: status is keyed by orderId (from on_confirm), not transactionId+messageId.
  </action>
  <verify>Check key-formatter.ts exports confirmKey, confirmChannel, statusKey, statusChannel functions and they're in keyFormatter object.</verify>
  <done>Key formatter has confirm and status functions with correct key structures.</done>
</task>

<task type="auto">
  <name>Task 2: Create confirm-store.ts</name>
  <files>server/src/lib/confirm-store.ts</files>
  <action>
Create confirm-store.ts by copying init-store.ts pattern exactly, with these changes:

1. Type Definitions:
   - ConfirmEntry: transactionId, messageId, orderId? (added after on_confirm), itemId, providerId, bppId, bppUri, quoteId, amount, confirmTimestamp, createdAt
   - OnConfirmResponse: context (OnConfirmContext), message?.order? with id, status, provider, items, quote, payments, fulfillments, created_at, updated_at, cancellation_terms, error?, _receivedAt
   - ConfirmResult: found, transactionId, messageId, orderId?, hasResponse, paymentStatus?, paymentUrl?, orderStatus?, provider?, items?, quote?, error?

2. Store Operations (copy init-store pattern):
   - createConfirmEntry(): Create entry with TTL (use 10 min like init)
   - addConfirmResponse(): Store response, extract orderId from message.order.id, publish to channel
   - getConfirmEntry(): Get entry by transactionId+messageId
   - getConfirmResponse(): Get response by transactionId+messageId
   - getConfirmResult(): Assemble full result with hasResponse, paymentStatus, etc.

3. Key differences from init-store:
   - Extract and store orderId from on_confirm response (needed for status polling)
   - Extract paymentStatus from payments[0].status
   - Extract paymentUrl from payments[0].url if payment needs retry
   - Extract orderStatus from order.status

Use 10 minute TTL (DEFAULT_STORE_TTL_MS = 10 * 60 * 1000) same as init-store.
  </action>
  <verify>TypeScript compiles without errors. Check exports: createConfirmEntry, addConfirmResponse, getConfirmResult, ConfirmEntry, ConfirmResult.</verify>
  <done>confirm-store.ts exists with all CRUD operations and correct type exports.</done>
</task>

<task type="auto">
  <name>Task 3: Create status-store.ts</name>
  <files>server/src/lib/status-store.ts</files>
  <action>
Create status-store.ts (SIMPLER than confirm-store - keyed by orderId):

1. Type Definitions:
   - StatusEntry: orderId, transactionId, bppId, bppUri, statusTimestamp, createdAt
   - PolicyDocument: descriptor? (code, name, short_desc, long_desc), mime_type?, url?
   - OnStatusResponse: context, message?.order? with id, status, provider, items, quote, payments, fulfillments, documents (PolicyDocument[]), error?, _receivedAt
   - StatusResult: found, orderId, transactionId, hasResponse, orderStatus?, paymentStatus?, fulfillmentStatus?, policyDocument?, provider?, items?, quote?, validFrom?, validTo?, error?

2. Store Operations:
   - createStatusEntry(): Create entry by orderId with 24h TTL (policy data needs longer TTL)
   - addStatusResponse(): Store response, publish to channel
   - getStatusEntry(): Get entry by orderId
   - getStatusResponse(): Get response by orderId
   - getStatusResult(): Assemble result with extracted fields

3. Key differences from confirm-store:
   - Keyed by orderId only (not transactionId+messageId)
   - Uses 24 hour TTL (POLICY_STORE_TTL_MS = 24 * 60 * 60 * 1000) per RESEARCH.md
   - Extracts policyDocument from documents array
   - Extracts fulfillmentStatus from fulfillments[0].state.descriptor.code
   - Extracts validity from time field (validFrom from time.range.start, duration from time.duration)

4. Helper for validity extraction:
   - Parse time.range.start for validFrom
   - Parse time.duration (ISO 8601: P1Y = 1 year) to calculate validTo
  </action>
  <verify>TypeScript compiles without errors. Check exports: createStatusEntry, addStatusResponse, getStatusResult, StatusEntry, StatusResult, PolicyDocument.</verify>
  <done>status-store.ts exists with orderId-keyed operations and 24h TTL.</done>
</task>

</tasks>

<verification>
1. TypeScript compilation: `cd server && pnpm exec tsc --noEmit`
2. All three files export required functions and types
3. Key patterns correct: confirm uses transactionId+messageId, status uses orderId only
4. TTLs correct: confirm 10min, status 24h
</verification>

<success_criteria>
- confirm-store.ts follows init-store pattern exactly with orderId extraction
- status-store.ts uses orderId-only keys and 24h TTL
- key-formatter.ts exports confirm and status key functions
- All TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/04-confirm-status/04-01-SUMMARY.md`
</output>
