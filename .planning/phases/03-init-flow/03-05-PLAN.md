---
phase: 03-init-flow
plan: 05
type: execute
wave: 3
depends_on: ["03-01", "03-04"]
files_modified:
  - client/src/routes/init/$transactionId/$messageId.tsx
  - client/src/routes/quote/$transactionId/$messageId.tsx
autonomous: true

must_haves:
  truths:
    - "Init polling page shows spinner while waiting for on_init response"
    - "Payment link from on_init redirects user to BPP payment page"
    - "BPP errors are displayed directly to user"
    - "Quote page Proceed button navigates to KYC flow"
    - "Init mutation auto-retries silently before showing error"
  artifacts:
    - path: "client/src/routes/init/$transactionId/$messageId.tsx"
      provides: "Init polling and redirect page"
      exports: ["Route"]
    - path: "client/src/routes/quote/$transactionId/$messageId.tsx"
      provides: "Updated quote page with working Proceed button"
      contains: "Proceed to Application"
  key_links:
    - from: "client/src/routes/init/$transactionId/$messageId.tsx"
      to: "trpc.results.getInitResults"
      via: "polling query"
      pattern: "getInitResults"
    - from: "client/src/routes/quote/$transactionId/$messageId.tsx"
      to: "/init/"
      via: "navigation after form submit"
      pattern: "navigate.*init"
---

<objective>
Create init polling page and wire quote page to KYC submission flow.

Purpose: Complete the frontend flow from quote selection through KYC to payment redirect.
Output: Working end-to-end init flow with polling and payment redirect.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-init-flow/03-RESEARCH.md
@.planning/phases/03-init-flow/03-01-SUMMARY.md
@.planning/phases/03-init-flow/03-04-SUMMARY.md

# Existing patterns
@client/src/routes/quote/$transactionId/$messageId.tsx
@client/src/trpc/client.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create init polling and redirect page</name>
  <files>client/src/routes/init/$transactionId/$messageId.tsx</files>
  <action>
Create directory structure and file client/src/routes/init/$transactionId/$messageId.tsx:

This page handles polling for on_init response and redirecting based on result.

1. Imports:
   - createFileRoute, Link from @tanstack/react-router
   - AlertCircle, ArrowLeft, Loader2, RefreshCw, ExternalLink from lucide-react
   - useState, useEffect from react
   - Button, Card, CardContent from components/ui
   - trpc from @/trpc/client

2. Create route:
   export const Route = createFileRoute("/init/$transactionId/$messageId")({
     component: InitPollingPage,
   });

3. InitPollingPage component:
   - Extract transactionId, messageId from Route.useParams()
   - Track startTime with useState(Date.now())

   - Polling query with timeout:
     const { data, isLoading, error, refetch } = trpc.results.getInitResults.useQuery(
       { transactionId, messageId },
       {
         refetchInterval: (query) => {
           const elapsed = Date.now() - startTime;
           // 60 second timeout
           if (elapsed > 60000) return false;
           // Stop on response or error
           if (query.state.data?.hasResponse || query.state.data?.error) return false;
           return 2000; // Poll every 2s
         },
         refetchIntervalInBackground: false,
       }
     );

   - Check for payment URL in response:
     const paymentUrl = data?.payments?.[0]?.url;
     const xinput = data?.xinput;
     const hasNextForm = xinput?.required && xinput?.form?.url;

   - Render states:

     a) Loading (initial):
        Spinner + "Processing your application..."

     b) Error (tRPC error):
        Error card with retry button and back to quote link

     c) Timeout (elapsed > 60000 && !data?.hasResponse):
        "Request timed out" message with retry button

     d) BPP error (data?.error):
        Display BPP error code and message directly (per user decision)
        Retry and back buttons

     e) Payment URL received:
        Success state:
        - "Application Approved!" heading
        - "You'll be redirected to complete payment"
        - Button with ExternalLink icon: "Proceed to Payment" that opens paymentUrl
        - Also auto-redirect after 3 seconds using useEffect with window.location.href

     f) Next form required (hasNextForm):
        For Phase 3, use redirect approach per research:
        - Show "Additional Information Required" message
        - Button to redirect to xinput.form.url
        - Note: BPP will redirect back after form completion

     g) Waiting for response (!data?.hasResponse):
        Spinner + "Waiting for insurer response..."
  </action>
  <verify>
    - File exists: `ls client/src/routes/init/\$transactionId/\$messageId.tsx`
    - Uses getInitResults: `grep "getInitResults" client/src/routes/init/\$transactionId/\$messageId.tsx`
    - TypeScript compiles: `pnpm exec tsc --noEmit -p client`
  </verify>
  <done>
    - Init polling page created with 60s timeout
    - Payment URL triggers redirect
    - BPP errors displayed directly
    - Next form requirement handled with redirect
    - All loading/error states covered
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire quote page to init flow with auto-retry</name>
  <files>client/src/routes/quote/$transactionId/$messageId.tsx</files>
  <action>
Update the quote page to integrate with KYC form and init submission:

1. Add imports:
   - useState for form visibility state
   - useNavigate from @tanstack/react-router
   - KYCForm, type KYCFormData from @/components/forms

2. Add state:
   - const [showKYCForm, setShowKYCForm] = useState(false);
   - const [initError, setInitError] = useState<string | null>(null);
   - const navigate = useNavigate();

3. Add init mutation WITH AUTO-RETRY (per user decision: retry 2-3 times silently):
   const initMutation = trpc.gateway.init.useMutation({
     retry: 3,
     retryDelay: (attemptIndex) => Math.min(1000 * 2 ** attemptIndex, 5000),
     onSuccess: (result) => {
       // Navigate to init polling page
       navigate({
         to: "/init/$transactionId/$messageId",
         params: { transactionId, messageId: result.messageId },
       });
     },
     onError: (error) => {
       // Only shown after all 3 retries exhausted
       console.error("Init failed after retries:", error);
       setInitError(error.message);
     },
   });

   IMPORTANT: The retry and retryDelay options ensure the mutation retries up to 3 times
   with exponential backoff (1s, 2s, 4s capped at 5s) before showing an error to the user.
   This implements the user decision: "retry 2-3 times, only show error if all fail".

4. Add form submit handler:
   const handleKYCSubmit = (formData: KYCFormData, submissionId: string) => {
     // Clear any previous error before new attempt
     setInitError(null);

     initMutation.mutate({
       transactionId,
       bppId: data?.bppId || "",
       bppUri: data?.bppUri || "",
       providerId: data?.providerId || "",
       itemId: data?.itemId || "",
       parentItemId: data?.item?.parent_item_id || data?.itemId || "",
       xinputFormId: data?.xinput?.form?.id || "",
       submissionId,
       addOns: selectedAddOns.map(id => ({ id, quantity: 1 })),
       customerName: `${formData.firstName} ${formData.lastName}`,
       customerEmail: formData.email,
       customerPhone: formData.phone,
       amount: quote?.price?.value || "0",
     });
   };

   Note: bppId and bppUri come from SelectResult (added in Task 3).

5. Update the Proceed button section:
   Replace the disabled button with conditional rendering:

   {!showKYCForm ? (
     <>
       <Button
         size="lg"
         className="w-full"
         onClick={() => setShowKYCForm(true)}
       >
         Proceed to Application
       </Button>
     </>
   ) : (
     <div className="space-y-6">
       <div className="flex items-center justify-between">
         <h2 className="text-xl font-semibold">Complete Your Application</h2>
         <Button variant="ghost" size="sm" onClick={() => setShowKYCForm(false)}>
           Cancel
         </Button>
       </div>
       <KYCForm
         quote={quote}
         onSubmit={handleKYCSubmit}
       />
       {initMutation.isPending && (
         <div className="text-center text-sm text-muted-foreground">
           Submitting application...
           {initMutation.failureCount > 0 && (
             <span className="ml-2 text-amber-600">
               (Retry {initMutation.failureCount}/3)
             </span>
           )}
         </div>
       )}
       {initError && (
         <div className="text-center text-sm text-destructive">
           {initError}
           <Button
             variant="link"
             size="sm"
             className="ml-2"
             onClick={() => {
               setInitError(null);
               // Re-trigger form submission - user needs to click submit again
             }}
           >
             Try again
           </Button>
         </div>
       )}
     </div>
   )}

6. Track selected add-ons properly (update existing state):
   Remove the underscore prefixes from _selectedAddOns and _addOnTotal since they're now used.
  </action>
  <verify>
    - KYCForm imported: `grep "KYCForm" client/src/routes/quote/\$transactionId/\$messageId.tsx`
    - init mutation with retry: `grep -A 5 "useMutation" client/src/routes/quote/\$transactionId/\$messageId.tsx | grep "retry"`
    - retryDelay configured: `grep "retryDelay" client/src/routes/quote/\$transactionId/\$messageId.tsx`
    - Navigate to init page: `grep "/init/" client/src/routes/quote/\$transactionId/\$messageId.tsx`
    - TypeScript compiles: `pnpm exec tsc --noEmit -p client`
  </verify>
  <done>
    - Quote page shows KYC form on Proceed click
    - Form submission triggers init mutation with auto-retry (3 attempts)
    - Retries use exponential backoff (1s, 2s, 4s capped at 5s)
    - Error only shown after all retries exhausted (per user decision)
    - Retry count displayed during pending retries
    - Success navigates to init polling page
    - Selected add-ons passed to init
  </done>
</task>

<task type="auto">
  <name>Task 3: Add bppId/bppUri to SelectResult</name>
  <files>server/src/lib/select-store.ts</files>
  <action>
Update SelectResult interface and getSelectResult function:

1. Add to SelectResult interface:
   bppId?: string;
   bppUri?: string;

2. Update getSelectResult function return to include:
   bppId: entry.bppId,
   bppUri: entry.bppUri,

This ensures the frontend has access to BPP information needed for init requests.
  </action>
  <verify>
    - SelectResult has bppId: `grep "bppId" server/src/lib/select-store.ts`
    - getSelectResult returns bppId: `grep -A 20 "return {" server/src/lib/select-store.ts | grep bppId`
    - TypeScript compiles: `pnpm exec tsc --noEmit -p server`
  </verify>
  <done>
    - SelectResult includes bppId and bppUri
    - getSelectResult returns these values
    - Frontend can access BPP info for init requests
  </done>
</task>

</tasks>

<verification>
1. TypeScript compilation passes: `pnpm exec tsc --noEmit`
2. Client builds: `cd client && pnpm build`
3. Init route created: `ls client/src/routes/init/\$transactionId/\$messageId.tsx`
4. Quote page uses KYCForm: `grep "KYCForm" client/src/routes/quote/\$transactionId/\$messageId.tsx`
5. Auto-retry configured: `grep -E "retry.*3|retryDelay" client/src/routes/quote/\$transactionId/\$messageId.tsx`
6. Payment redirect logic exists: `grep "paymentUrl" client/src/routes/init/\$transactionId/\$messageId.tsx`
</verification>

<success_criteria>
- Init polling page polls for on_init response with 60s timeout
- Payment URL triggers automatic redirect to BPP payment page
- BPP errors displayed directly per user decision
- Quote page Proceed button shows KYC form
- Form submission triggers init mutation with auto-retry (3 attempts, exponential backoff)
- Error only displayed after all retries exhausted (per user decision)
- Success navigates to polling page
- SelectResult includes bppId/bppUri for init request
</success_criteria>

<output>
After completion, create `.planning/phases/03-init-flow/03-05-SUMMARY.md`
</output>
