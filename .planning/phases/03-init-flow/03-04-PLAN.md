---
phase: 03-init-flow
plan: 04
type: execute
wave: 2
depends_on: ["03-02", "03-03"]
files_modified:
  - client/src/components/forms/KYCForm.tsx
autonomous: true

must_haves:
  truths:
    - "KYCForm has 5 steps: Personal, Identity, Health, Nominee, Review"
    - "Nominee step is prompt-but-skippable with Add Nominee button and Skip option"
    - "Review step shows all data with edit links that navigate to correct step"
    - "Form cannot be submitted without T&C acceptance"
  artifacts:
    - path: "client/src/components/forms/KYCForm.tsx"
      provides: "Complete 5-step KYC form with nominee and review"
      exports: ["KYCForm", "KYCFormData"]
  key_links:
    - from: "client/src/components/forms/KYCForm.tsx"
      to: "client/src/components/forms/fields/NomineeInput.tsx"
      via: "NomineeInput for nominee entry"
      pattern: "import.*NomineeInput"
    - from: "client/src/components/forms/KYCForm.tsx"
      to: "client/src/components/review/ReviewPage.tsx"
      via: "ReviewPage for final review"
      pattern: "import.*ReviewPage"
    - from: "client/src/components/forms/KYCForm.tsx"
      to: "client/src/lib/form-schemas/nominee.ts"
      via: "nomineesSchema for validation"
      pattern: "import.*nominee"
---

<objective>
Extend KYCForm with Nominee step (prompt-but-skippable) and Review step with full data display.

Purpose: Complete the KYC flow allowing users to add nominees and review before submission.
Output: 5-step KYCForm ready for init endpoint integration.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-init-flow/03-RESEARCH.md
@.planning/phases/03-init-flow/03-02-SUMMARY.md
@.planning/phases/03-init-flow/03-03-SUMMARY.md

# File to extend
@client/src/components/forms/KYCForm.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add nominees and termsAccepted to schema</name>
  <files>client/src/components/forms/KYCForm.tsx</files>
  <action>
Update the KYCForm.tsx file:

1. Add imports at top:
   - import { NomineeInput, type NomineeData } from "./fields";
   - import { ReviewPage } from "../review";
   - import { nomineesSchema, NOMINEE_RELATIONSHIPS } from "@/lib/form-schemas/nominee";
   - import { Plus } from "lucide-react";

2. Update kycFormSchema to include:
   - nominees: nomineesSchema.optional().default([])
   - termsAccepted: z.boolean().default(false)

3. Update defaultValues to include:
   - nominees: []
   - termsAccepted: false

4. Update KYCFormData type will auto-infer from schema.

5. Update STEP_TITLES array to 5 items:
   ["Personal Information", "Identity Verification", "Health Information", "Nominee Details", "Review & Submit"]

6. Update getStepFields function to handle steps 3 and 4:
   - case 3: return ["nominees"]
   - case 4: return ["termsAccepted"]
  </action>
  <verify>
    - Schema includes nominees: `grep "nominees:" client/src/components/forms/KYCForm.tsx`
    - STEP_TITLES has 5 items: `grep -A 6 "STEP_TITLES" client/src/components/forms/KYCForm.tsx`
    - TypeScript compiles: `pnpm exec tsc --noEmit -p client`
  </verify>
  <done>
    - Schema extended with nominees array and termsAccepted boolean
    - Default values include empty nominees array
    - STEP_TITLES reflects 5-step flow
    - getStepFields handles all 5 steps
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Nominee and Review steps to form</name>
  <files>client/src/components/forms/KYCForm.tsx</files>
  <action>
Continue updating KYCForm.tsx:

1. Add state for nominee mode:
   const [showNomineeForm, setShowNomineeForm] = useState(false);

2. Add watch for nominees and termsAccepted:
   const nominees = watch("nominees") || [];
   const termsAccepted = watch("termsAccepted");

3. Add nominee management handlers:
   const addNominee = useCallback(() => {
     const current = getValues("nominees") || [];
     if (current.length < 2) {
       setValue("nominees", [...current, { firstName: "", lastName: "", dateOfBirth: "", relationship: "" as const }]);
       setShowNomineeForm(true);
     }
   }, [getValues, setValue]);

   const updateNominee = useCallback((index: number, nominee: NomineeData) => {
     const current = getValues("nominees") || [];
     const updated = [...current];
     updated[index] = nominee;
     setValue("nominees", updated);
     saveData(getValues()); // persist
   }, [getValues, setValue, saveData]);

   const removeNominee = useCallback((index: number) => {
     const current = getValues("nominees") || [];
     setValue("nominees", current.filter((_, i) => i !== index));
     saveData(getValues()); // persist
   }, [getValues, setValue, saveData]);

4. Add goToStep helper for review edit navigation:
   const goToStep = useCallback((step: number) => {
     setCurrentStep(step);
   }, []);

5. Create section-to-step mapping:
   const sectionStepMap = { personal: 0, identity: 1, health: 2, nominee: 3 };

6. Add Step 4 (Nominee) inside MultiStepForm after Step 3 (Health):
   <FormStep
     title="Nominee Details"
     description="Add beneficiaries for your policy (optional)"
   >
     <div className="space-y-6">
       {!showNomineeForm && nominees.length === 0 ? (
         <div className="text-center py-8">
           <p className="text-muted-foreground mb-4">
             Would you like to add a nominee to your policy?
           </p>
           <div className="flex flex-col sm:flex-row gap-3 justify-center">
             <Button type="button" onClick={() => { addNominee(); }}>
               <Plus className="h-4 w-4 mr-2" />
               Add Nominee
             </Button>
             <Button type="button" variant="ghost" onClick={goToNextStep}>
               Skip for Now
             </Button>
           </div>
         </div>
       ) : (
         <div className="space-y-4">
           {nominees.map((nominee, index) => (
             <NomineeInput
               key={index}
               nominee={nominee}
               index={index}
               onUpdate={(updated) => updateNominee(index, updated)}
               onRemove={() => removeNominee(index)}
             />
           ))}
           {nominees.length < 2 && (
             <Button type="button" variant="outline" onClick={addNominee}>
               <Plus className="h-4 w-4 mr-2" />
               Add Another Nominee
             </Button>
           )}
         </div>
       )}
     </div>
   </FormStep>

7. Add Step 5 (Review) as last FormStep:
   Note: ReviewPage needs quote prop. For now, pass a placeholder quote object.
   The quote will come from parent component via props in actual usage.

   Add quote prop to KYCFormProps:
   quote?: { price: { currency: string; value: string }; breakup?: Array<{ title: string; price: { currency: string; value: string } }> };

   <FormStep
     title="Review & Submit"
     description="Verify your details before proceeding"
   >
     <ReviewPage
       formData={getValues()}
       quote={quote || { price: { currency: "INR", value: "0" } }}
       onEdit={(section) => goToStep(sectionStepMap[section])}
       onSubmit={() => {}} // Handled by form submit
       termsAccepted={termsAccepted}
       onTermsChange={(checked) => {
         setValue("termsAccepted", checked);
         saveData(getValues());
       }}
     />
   </FormStep>

8. Update navigation buttons section:
   - Change currentStep < 2 to currentStep < 4 for Next button condition
   - Final step (4) shows Submit button
   - Disable Submit if !termsAccepted

9. Update StepProgress totalSteps to 5.
  </action>
  <verify>
    - Nominee step exists: `grep "Nominee Details" client/src/components/forms/KYCForm.tsx`
    - Review step exists: `grep "Review & Submit" client/src/components/forms/KYCForm.tsx`
    - NomineeInput imported: `grep "NomineeInput" client/src/components/forms/KYCForm.tsx`
    - ReviewPage imported: `grep "ReviewPage" client/src/components/forms/KYCForm.tsx`
    - TypeScript compiles: `pnpm exec tsc --noEmit -p client`
    - Dev client builds: `cd /Users/sudomakes/conductor/workspaces/ondc-vaatun/lisbon/client && pnpm build`
  </verify>
  <done>
    - KYCForm now has 5 steps
    - Nominee step shows Add/Skip prompt, then nominee forms
    - Review step displays ReviewPage with all data
    - Edit links in review navigate to correct steps
    - T&C checkbox controls submit button
    - Form compiles and builds successfully
  </done>
</task>

</tasks>

<verification>
1. TypeScript compilation passes: `pnpm exec tsc --noEmit -p client`
2. Client builds successfully: `cd client && pnpm build`
3. 5 steps defined: `grep -c "FormStep" client/src/components/forms/KYCForm.tsx` returns 5
4. Nominee imports present: `grep -E "NomineeInput|nomineesSchema" client/src/components/forms/KYCForm.tsx`
5. Review imports present: `grep "ReviewPage" client/src/components/forms/KYCForm.tsx`
</verification>

<success_criteria>
- KYCForm renders 5 steps with correct titles
- Nominee step prompt-but-skippable (Add/Skip buttons)
- Max 2 nominees enforced
- Review step shows all entered data
- Edit buttons navigate to correct step
- Submit disabled without T&C acceptance
- All TypeScript compiles without errors
- Client builds successfully
</success_criteria>

<output>
After completion, create `.planning/phases/03-init-flow/03-04-SUMMARY.md`
</output>
