---
phase: 05-error-classification-logging
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - server/src/lib/ondc/error-classifier.ts
  - server/src/lib/ondc/client.ts
  - server/src/trpc/routers/gateway.ts
autonomous: true

must_haves:
  truths:
    - "BPP 4xx/5xx errors have error.source='bpp' on the span"
    - "Network failures (timeout, DNS, connection refused) have error.source='network' on the span"
    - "Gateway/registry failures have error.source='gateway' on the span"
    - "BAP validation errors have error.source='bap' on the span"
    - "All errors have span.recordException() called with stack trace"
    - "BPP NACK responses in callbacks have error.source='bpp' and bpp.error attributes"
  artifacts:
    - path: "server/src/lib/ondc/error-classifier.ts"
      provides: "classifyErrorSource function and ErrorSource type"
      exports: ["classifyErrorSource", "ErrorSource"]
    - path: "server/src/lib/ondc/client.ts"
      provides: "Error classification in ONDCClient.send() catch block"
      contains: "classifyErrorSource"
    - path: "server/src/trpc/routers/gateway.ts"
      provides: "error.source attribute on callback NACK spans"
      contains: "error.source"
  key_links:
    - from: "server/src/lib/ondc/client.ts"
      to: "server/src/lib/ondc/error-classifier.ts"
      via: "import classifyErrorSource"
      pattern: "import.*classifyErrorSource.*error-classifier"
    - from: "server/src/lib/ondc/client.ts"
      to: "span.setAttribute"
      via: "error.source attribute in catch block"
      pattern: "span\\.setAttribute\\(['\"]error\\.source['\"]"
    - from: "server/src/trpc/routers/gateway.ts"
      to: "span.setAttribute"
      via: "error.source on BPP NACK callbacks"
      pattern: "error\\.source.*bpp"
---

<objective>
Add error source classification to the ONDC HTTP client and enrich callback handler spans with error attribution.

Purpose: Enables distinguishing BAP errors from BPP errors from gateway errors from network errors in SigNoz traces. This is the core of OTEL-08 -- without error.source, all failures look the same in the trace UI.

Output: A classifyErrorSource() helper, enriched ONDCClient.send() error handling, and BPP NACK attribution on all 5 callback handlers.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-error-classification-logging/05-CONTEXT.md
@.planning/phases/05-error-classification-logging/05-RESEARCH.md
@server/src/lib/ondc/client.ts
@server/src/trpc/routers/gateway.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create error classifier and integrate into ONDCClient</name>
  <files>
    server/src/lib/ondc/error-classifier.ts
    server/src/lib/ondc/client.ts
  </files>
  <action>
    Create `server/src/lib/ondc/error-classifier.ts` with:

    1. Export `type ErrorSource = 'bap' | 'bpp' | 'gateway' | 'network'`

    2. Export `function classifyErrorSource(error: Error, response?: Response, url?: string): ErrorSource` with this classification logic:
       - If NO response object exists (fetch threw before getting a response):
         - Check error.message for 'ECONNREFUSED', 'ETIMEDOUT', 'ENOTFOUND', 'DNS', or error.name === 'AbortError' -> return 'network'
       - If response exists and response.status >= 400 -> return 'bpp' (BPP returned HTTP error)
       - If url contains '/lookup' or '/subscribe', or error.message contains 'gateway' or 'registry' (case-insensitive) -> return 'gateway'
       - Default fallback -> return 'bap' (our own code/validation error)

    Then modify `server/src/lib/ondc/client.ts`:

    1. Import `classifyErrorSource` from `./error-classifier`
    2. In `ONDCClient.send()`, the catch block currently does:
       ```
       span.recordException(error as Error);
       span.setStatus({ code: 2, message: ... });
       console.error(...);
       throw error;
       ```
       Change it to also classify the error and add attributes. The response variable is declared inside the try block, so to make it available in catch, declare `let response: Response | undefined` before the try block and assign it inside. Then in catch:
       ```typescript
       const errorSource = classifyErrorSource(error as Error, response, url.toString());
       span.recordException(error as Error);
       span.setAttribute('error.source', errorSource);
       span.setAttribute('error.message', (error as Error).message);
       if ((error as Error & { code?: string }).code) {
         span.setAttribute('error.code', (error as Error & { code?: string }).code as string);
       }
       span.setStatus({ code: 2 as typeof SpanStatusCode.ERROR, message: (error as Error).message });
       console.error(`[ONDCClient] Error sending to ${url}:`, error);
       throw error;
       ```
       Note: Keep the existing console.error for now -- Plan 02 will migrate it to pino.

    3. For the non-ok response path (status >= 400), the code currently throws `new Error(...)`. Before throwing, add error.source classification on the span. The response IS available here since we got an HTTP response. Add:
       ```typescript
       span.setAttribute('error.source', 'bpp');
       ```
       right before the `throw new Error(...)` line in the `if (!response.ok)` block. This handles the case where BPP returns 4xx/5xx but the fetch itself succeeded.

    IMPORTANT: The `response` variable is currently `const response = await fetch(...)` inside the try block. Refactor to `let response: Response | undefined;` declared before the startActiveSpan callback's try block, then assign `response = await fetch(...)` inside. This makes it available in the catch block for classification.
  </action>
  <verify>
    Run `cd /Users/sudomakes/conductor/workspaces/ondc-vaatun/medan && npx tsc --noEmit --project server/tsconfig.json` to verify no TypeScript errors. Grep for 'classifyErrorSource' in client.ts to confirm import and usage. Grep for 'error.source' in client.ts to confirm span attribute is set.
  </verify>
  <done>
    error-classifier.ts exports classifyErrorSource and ErrorSource type. ONDCClient.send() classifies errors and sets error.source, error.message, and error.code (if available) span attributes on all failures. Both HTTP error responses (4xx/5xx) and network/fetch errors are classified.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add error.source attribution to callback NACK handlers</name>
  <files>
    server/src/trpc/routers/gateway.ts
  </files>
  <action>
    In `server/src/trpc/routers/gateway.ts`, there are 5 callback handlers (onSearch, onSelect, onInit, onConfirm, onStatus) that already check for `input.error` and set SpanStatusCode.ERROR. Enrich each one with error source attribution.

    For each of the 5 callback handlers (onSearch, onSelect, onInit, onConfirm, onStatus), find the `if (input.error)` block inside the callback span and add these attributes BEFORE the existing `span.setStatus()` call:

    ```typescript
    span.setAttribute('error.source', 'bpp');
    span.setAttribute('error.message', input.error.message || 'BPP NACK');
    if (input.error.code) {
      span.setAttribute('error.code', input.error.code);
    }
    span.setAttribute('bpp.error', JSON.stringify(input.error));
    ```

    Also, for each callback handler's catch block (which handles BAP-side exceptions), add error.source='bap' attribution:

    ```typescript
    // In each catch (error) block, add BEFORE the existing span.recordException:
    span.setAttribute('error.source', 'bap');
    span.setAttribute('error.message', (error as Error).message);
    ```

    Similarly, for each OUTBOUND procedure (search, select, init, confirm, status), add error.source='bap' to their catch blocks:

    ```typescript
    // In each outbound procedure catch block, add BEFORE span.recordException:
    span.setAttribute('error.source', 'bap');
    span.setAttribute('error.message', (error as Error).message);
    ```

    This gives every error span an error.source attribute regardless of where it originates.

    Do NOT modify the console.log/console.warn statements in this file -- Plan 02 handles that migration.
  </action>
  <verify>
    Run `cd /Users/sudomakes/conductor/workspaces/ondc-vaatun/medan && npx tsc --noEmit --project server/tsconfig.json` to verify no TypeScript errors. Run `grep -c "error.source" server/src/trpc/routers/gateway.ts` -- should show at least 15 occurrences (5 callback NACK blocks + 5 callback catch blocks + 5 outbound catch blocks).
  </verify>
  <done>
    All 10 gateway procedures (5 outbound + 5 callbacks) set error.source span attribute on every error path. BPP NACK responses get error.source='bpp' with bpp.error JSON attribute. BAP-side exceptions get error.source='bap'. error.message is always present.
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles without errors: `npx tsc --noEmit --project server/tsconfig.json`
2. error-classifier.ts exists and exports classifyErrorSource function
3. ONDCClient.send() sets error.source attribute in catch block using classifyErrorSource
4. ONDCClient.send() sets error.source='bpp' for non-ok HTTP responses (before throw)
5. All 5 callback handlers set error.source='bpp' on NACK responses
6. All 10 gateway procedure catch blocks set error.source attribute
7. No changes to console.log calls (deferred to Plan 02)
</verification>

<success_criteria>
- error-classifier.ts exists with correct 4-source classification logic
- Every error span in the ONDC client and gateway router has error.source attribute
- BPP 4xx/5xx = error.source='bpp', network failures = error.source='network', gateway = error.source='gateway', BAP errors = error.source='bap'
- BPP NACK callbacks capture the full NACK error object as bpp.error span attribute
- TypeScript compiles cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/05-error-classification-logging/05-01-SUMMARY.md`
</output>
