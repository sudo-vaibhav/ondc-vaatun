---
phase: 05-error-classification-logging
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - server/src/lib/logger.ts
  - server/src/tracing.ts
  - server/src/index.ts
  - server/src/app.ts
  - server/src/lib/ondc/client.ts
  - server/src/trpc/routers/gateway.ts
  - server/src/trpc/routers/registry.ts
  - server/src/routes/ondc-compat.ts
  - server/src/routes/sse.ts
  - server/src/routes/site-verification.ts
  - server/src/entities/tenant.ts
  - server/src/infra/key-value/redis/store.ts
  - server/src/lib/search-store.ts
  - server/src/lib/select-store.ts
  - server/src/lib/init-store.ts
  - server/src/lib/confirm-store.ts
  - server/src/lib/status-store.ts
  - server/package.json
autonomous: true

must_haves:
  truths:
    - "Every log line in production includes trace_id and span_id fields (injected by PinoInstrumentation)"
    - "Development logs are pretty-printed with colors and timestamps"
    - "Production logs are JSON lines format"
    - "No console.log/console.error/console.warn calls remain in server/src/"
    - "Outbound ONDC requests logged at info level"
    - "Callback arrivals logged at info level"
    - "BPP NACK responses logged at warn level"
    - "BAP-side exceptions logged at error level"
  artifacts:
    - path: "server/src/lib/logger.ts"
      provides: "Pino logger instance with conditional dev/prod transport"
      exports: ["logger"]
    - path: "server/src/tracing.ts"
      provides: "PinoInstrumentation added to SDK instrumentations"
      contains: "PinoInstrumentation"
  key_links:
    - from: "server/src/tracing.ts"
      to: "@opentelemetry/instrumentation-pino"
      via: "PinoInstrumentation in instrumentations array"
      pattern: "new PinoInstrumentation"
    - from: "server/src/lib/logger.ts"
      to: "pino"
      via: "pino import for logger creation"
      pattern: "import pino from"
    - from: "server/src/index.ts"
      to: "server/src/lib/logger.ts"
      via: "logger import (after tracing import)"
      pattern: "import.*logger"
---

<objective>
Install pino and @opentelemetry/instrumentation-pino, create a structured logger, and migrate all 119 console.* calls across 16 server files to structured pino logging with automatic trace context injection.

Purpose: Enables log-trace correlation in SigNoz -- every log line carries trace_id/span_id, so you can jump from a log entry to its trace and vice versa. Fulfills OTEL-07 (structured logging with trace context).

Output: A pino logger module, PinoInstrumentation in the OTel SDK, and zero console.* calls remaining in server/src/.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-error-classification-logging/05-CONTEXT.md
@.planning/phases/05-error-classification-logging/05-RESEARCH.md
@.planning/phases/05-error-classification-logging/05-01-SUMMARY.md
@server/src/tracing.ts
@server/src/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install pino, create logger, add PinoInstrumentation to tracing</name>
  <files>
    server/package.json
    server/src/lib/logger.ts
    server/src/tracing.ts
  </files>
  <action>
    1. Install dependencies:
       ```bash
       cd server && pnpm add pino @opentelemetry/instrumentation-pino && pnpm add -D pino-pretty
       ```

    2. Create `server/src/lib/logger.ts`:
       ```typescript
       import pino from 'pino';

       const isDevelopment = process.env.NODE_ENV !== 'production';

       export const logger = pino({
         level: process.env.LOG_LEVEL || (isDevelopment ? 'debug' : 'info'),
         transport: isDevelopment ? {
           target: 'pino-pretty',
           options: {
             colorize: true,
             translateTime: 'HH:MM:ss Z',
             ignore: 'pid,hostname',
           },
         } : undefined,
       });
       ```
       CRITICAL: This file must only be imported AFTER tracing.ts has initialized the SDK, because PinoInstrumentation monkey-patches pino at require time. Since tracing.ts is imported first in index.ts, and logger.ts is imported later by other modules, this ordering is naturally correct. Do NOT import logger.ts from tracing.ts.

    3. Modify `server/src/tracing.ts`:
       - Add import: `import { PinoInstrumentation } from '@opentelemetry/instrumentation-pino';`
       - Add `new PinoInstrumentation()` to the instrumentations array, AFTER getNodeAutoInstrumentations:
         ```typescript
         instrumentations: [
           getNodeAutoInstrumentations({
             // ... existing config
           }),
           new PinoInstrumentation(),
         ],
         ```
       - Migrate the 3 console.* calls in tracing.ts itself to use pino. BUT there's a chicken-and-egg problem: tracing.ts runs before pino is instrumented. For tracing.ts specifically, keep using console.log for the SDK startup message (`[OpenTelemetry] SDK initialized`) and the shutdown messages. These are one-time startup/shutdown logs that don't need trace context.
  </action>
  <verify>
    Run `cd /Users/sudomakes/conductor/workspaces/ondc-vaatun/medan && npx tsc --noEmit --project server/tsconfig.json` to verify TypeScript compiles. Verify logger.ts exists and exports logger. Verify tracing.ts contains PinoInstrumentation.
  </verify>
  <done>
    pino and @opentelemetry/instrumentation-pino installed. logger.ts exports a configured pino logger with dev/prod conditional transport. PinoInstrumentation added to OTel SDK in tracing.ts. tracing.ts keeps its own console.log for startup (chicken-and-egg).
  </done>
</task>

<task type="auto">
  <name>Task 2: Migrate all console.* calls to structured pino logging</name>
  <files>
    server/src/index.ts
    server/src/app.ts
    server/src/lib/ondc/client.ts
    server/src/trpc/routers/gateway.ts
    server/src/trpc/routers/registry.ts
    server/src/routes/ondc-compat.ts
    server/src/routes/sse.ts
    server/src/routes/site-verification.ts
    server/src/entities/tenant.ts
    server/src/infra/key-value/redis/store.ts
    server/src/lib/search-store.ts
    server/src/lib/select-store.ts
    server/src/lib/init-store.ts
    server/src/lib/confirm-store.ts
    server/src/lib/status-store.ts
  </files>
  <action>
    Add `import { logger } from '../lib/logger';` (adjust relative path per file) to each file and replace ALL console.log/error/warn calls with structured pino calls.

    Apply these log level rules from CONTEXT.md decisions:
    - **logger.info**: Outbound ONDC requests, callback arrivals, startup messages, store operations
    - **logger.warn**: BPP NACK/error responses, missing data warnings, subscriber ID mismatches
    - **logger.error**: BAP-side exceptions, catch blocks, initialization failures
    - **logger.debug**: Verbose debug data (response bodies, payload dumps -- these were console.log before)

    Migration rules per file type:

    **Gateway procedures (gateway.ts) -- 30 calls:**
    - Outbound request logs like `console.log("[Search] Sending request to:", url)` become:
      `logger.info({ action: 'search', url: gatewayUrl.toString() }, 'Sending ONDC request')`
    - Response logs like `console.log("[Search] ONDC Response:", ...)` become:
      `logger.debug({ action: 'search' }, 'ONDC response received')` -- full payload is already in span attributes, no need to duplicate
    - Callback body logs like `console.log("[on_search] Request Body:", ...)` become:
      `logger.info({ action: 'on_search', transactionId }, 'Received ONDC callback')`
    - Warning logs like `console.warn("[on_search] No transaction_id")` become:
      `logger.warn({ action: 'on_search' }, 'Missing transaction_id in callback context')`
    - Trace context warnings like `console.warn("[on_search] No trace context found")` become:
      `logger.warn({ action: 'on_search', transactionId }, 'No trace context found for transaction')`

    **Registry router (registry.ts) -- 9 calls:**
    - Same pattern as gateway: info for requests, debug for responses, warn for mismatches
    - `console.log("[on_subscribe] Answer:", answer)` -> `logger.debug({ action: 'on_subscribe' }, 'Challenge decrypted')`

    **ONDC client (client.ts) -- 2 calls:**
    - `console.log("[Signing] Created:", ...)` -> `logger.debug({ created, timestamp: bodyWithContext?.context?.timestamp }, 'Authorization header created')`
    - `console.error("[ONDCClient] Error sending to ...")` -> `logger.error({ err: error, url: url.toString() }, 'ONDC request failed')`
    - NOTE: Use `err` as the key for error objects -- pino has a built-in error serializer that triggers on the `err` key.

    **ONDC compat routes (ondc-compat.ts) -- 40 calls:**
    - Same patterns as gateway/registry. These are REST duplicates of the tRPC procedures.
    - All catch blocks: `console.error("[X] Error:", error)` -> `logger.error({ err: error }, 'X failed')`
    - All request logs: `console.log("[X] Sending request to:", url)` -> `logger.info({ action: 'x', url }, 'Sending ONDC request')`
    - All callback body logs: `console.log("[on_x] Request Body:", ...)` -> `logger.info({ action: 'on_x', transactionId }, 'Received ONDC callback')`
    - BPP error logs: `console.error("[on_x] BPP returned error:", ...)` -> `logger.warn({ action: 'on_x', bppError: body.error }, 'BPP returned error response')`

    **Index/startup (index.ts) -- 7 calls:**
    - Server startup: `console.log("[Server] Running on ...")` -> `logger.info({ port: PORT }, 'Server running')`
    - Keep the individual endpoint URLs in a single info log: `logger.info({ port: PORT, trpc: '/api/trpc', health: '/health', docs: '/api/reference' }, 'Server started')`
    - ngrok: `console.log("[ngrok] Tunnel established at: ...")` -> `logger.info({ url: listener.url() }, 'ngrok tunnel established')`
    - ngrok error: `console.error("[ngrok] Failed:", err)` -> `logger.error({ err }, 'ngrok tunnel failed')`
    - ngrok skip: `console.log("[ngrok] Skipped")` -> `logger.info('ngrok skipped in production')`

    **App error handler (app.ts) -- 1 call:**
    - `console.error("[Server Error]", err)` -> `logger.error({ err }, 'Unhandled server error')`

    **Tenant entity (tenant.ts) -- 4 calls:**
    - `console.log("[Tenant] Initialized successfully:", {...})` -> `logger.info({ subscriberId, subscribeRequestId }, 'Tenant initialized')`
    - `console.error("[Tenant] Failed to initialize:", error)` -> `logger.error({ err: error }, 'Tenant initialization failed')`
    - `console.error("[Tenant] Decryption failed:", error)` -> `logger.error({ err: error }, 'Challenge decryption failed')`
    - `console.error("[Tenant] Signing failed:", error)` -> `logger.error({ err: error }, 'Message signing failed')`

    **Store files (5 files, ~16 calls total):**
    - `console.log("[XStore] Created entry: ...")` -> `logger.info({ store: 'x', key }, 'Store entry created')`
    - `console.warn("[XStore] No entry found")` -> `logger.warn({ store: 'x', key }, 'Store entry not found, creating new')`
    - `console.log("[XStore] Added response")` -> `logger.info({ store: 'x', key }, 'Store response added')`

    **SSE (sse.ts) -- 2 calls:**
    - `console.log("[SSE] Client disconnected")` -> `logger.info({ transactionId }, 'SSE client disconnected')`
    - `console.error("[SSE] Stream error:", error)` -> `logger.error({ err: error }, 'SSE stream error')`

    **Site verification (site-verification.ts) -- 1 call:**
    - `console.error("[Site Verification] Error:", error)` -> `logger.error({ err: error }, 'Site verification page generation failed')`

    **Redis store (infra/key-value/redis/store.ts) -- 4 calls:**
    - `console.error("[KV] Failed to subscribe")` -> `logger.error({ err }, 'KV subscription failed')`
    - `console.error("[KV] Error in subscriber callback")` -> `logger.error({ err: error }, 'KV subscriber callback error')`
    - `console.error("[KV] Failed to set up subscription")` -> `logger.error({ err: error }, 'KV subscription setup failed')`
    - `console.log("[KV] ...")` -> `logger.info(...)` (whatever the log says)

    IMPORTANT NOTES:
    - Do NOT log full payloads/response bodies to pino. The spans already capture these. Log metadata only (action, url, transactionId, error info).
    - Use `err` key (not `error`) for Error objects to trigger pino's built-in error serializer.
    - Do NOT add transactionId/action to log lines for traced code -- the trace context (trace_id/span_id) auto-injected by PinoInstrumentation provides the correlation.
    - EXCEPTION: For callback arrival logs, include transactionId and action since these are useful for quick log scanning without opening traces.
    - Keep tracing.ts console.log calls as-is (3 calls for SDK startup/shutdown -- chicken-and-egg).

    After all migrations, verify zero console.* calls remain by running:
    `grep -rn "console\.\(log\|error\|warn\)" server/src/ --include="*.ts" | grep -v tracing.ts | grep -v node_modules`
    This should return ZERO results (tracing.ts is excluded since it keeps its startup logs).
  </action>
  <verify>
    1. Run `cd /Users/sudomakes/conductor/workspaces/ondc-vaatun/medan && npx tsc --noEmit --project server/tsconfig.json` -- should pass with no errors.
    2. Run `grep -rn "console\.\(log\|error\|warn\)" server/src/ --include="*.ts" | grep -v tracing.ts` -- should return ZERO results.
    3. Run `grep -rn "import.*logger" server/src/ --include="*.ts" | wc -l` -- should show 15+ files importing the logger.
  </verify>
  <done>
    All 119 console.* calls across 15 files (excluding tracing.ts) migrated to structured pino logging. Log levels follow the decided strategy: info for requests/callbacks, warn for BPP errors, error for BAP exceptions. No full payloads duplicated in logs. Zero console.* calls remain outside tracing.ts.
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles: `npx tsc --noEmit --project server/tsconfig.json`
2. Zero console.* in server/src (except tracing.ts): `grep -rn "console\." server/src/ --include="*.ts" | grep -v tracing.ts | grep -v node_modules` returns empty
3. logger.ts exists and exports pino logger
4. PinoInstrumentation in tracing.ts instrumentations array
5. pino and @opentelemetry/instrumentation-pino in server/package.json dependencies
6. pino-pretty in server/package.json devDependencies
</verification>

<success_criteria>
- pino installed as production dependency, pino-pretty as devDependency
- PinoInstrumentation registered in OTel SDK
- logger.ts provides conditional dev (pretty) / prod (JSON) logger
- All 119 console.* calls replaced with structured pino calls
- Log levels correct: info for requests/callbacks, warn for BPP errors, error for BAP exceptions
- No payload duplication (metadata only in logs, full payloads in spans)
- tracing.ts retains console.log for SDK startup/shutdown (3 calls)
</success_criteria>

<output>
After completion, create `.planning/phases/05-error-classification-logging/05-02-SUMMARY.md`
</output>
