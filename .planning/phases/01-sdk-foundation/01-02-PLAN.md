# Plan 01-02: Create SigNoz Local Deployment

**Phase**: 1 - SDK Foundation
**Depends on**: Nothing (SigNoz runs independently of app packages)
**Requirement(s)**: OTEL-06

## Goal
SigNoz running locally via docker-compose with OTLP collector ready to receive traces.

## Context
SigNoz provides the trace backend for viewing distributed traces. It uses ClickHouse for storage and exposes an OTLP collector on port 4318 (HTTP). We're creating a minimal docker-compose setup with 4 services: ClickHouse (database), OTel Collector (trace ingestion), Query Service (API), and Frontend (UI). This runs independently from the BAP server and can be started/stopped as needed for development. Prerequisites: Docker Desktop must be running.

## Tasks

### Task 1: Create OTel Collector configuration
**File**: `otel-collector-config.yaml`
**Action**: create
**Why**: Configure the OpenTelemetry Collector to receive OTLP traces on port 4318 and export to ClickHouse.

Create this file in the project root:

```yaml
# otel-collector-config.yaml
# SigNoz OpenTelemetry Collector configuration
receivers:
  otlp:
    protocols:
      grpc:
        endpoint: 0.0.0.0:4317
      http:
        endpoint: 0.0.0.0:4318
        cors:
          allowed_origins:
            - "http://localhost:4822"  # BAP server
            - "http://localhost:4823"  # Client dev server

processors:
  batch:
    timeout: 5s
    send_batch_size: 1024

exporters:
  clickhouse:
    endpoint: tcp://clickhouse:9000?database=signoz
    ttl: 72h

service:
  pipelines:
    traces:
      receivers: [otlp]
      processors: [batch]
      exporters: [clickhouse]
```

### Task 2: Create SigNoz docker-compose file
**File**: `docker-compose.signoz.yml`
**Action**: create
**Why**: Define the 4 SigNoz services needed for local trace visualization.

Create this file in the project root:

```yaml
# docker-compose.signoz.yml
# SigNoz local deployment for OpenTelemetry traces
version: '3.8'

services:
  clickhouse:
    image: clickhouse/clickhouse-server:24.1.2-alpine
    container_name: signoz-clickhouse
    volumes:
      - clickhouse-data:/var/lib/clickhouse
    ports:
      - "9000:9000"
      - "8123:8123"
    environment:
      - CLICKHOUSE_DB=signoz

  otel-collector:
    image: signoz/signoz-otel-collector:0.88.11
    container_name: signoz-otel-collector
    command: ["--config=/etc/otel-collector-config.yaml"]
    volumes:
      - ./otel-collector-config.yaml:/etc/otel-collector-config.yaml
    ports:
      - "4317:4317"   # OTLP gRPC
      - "4318:4318"   # OTLP HTTP (used by our app)
    depends_on:
      - clickhouse

  query-service:
    image: signoz/query-service:0.44.2
    container_name: signoz-query-service
    command: ["-config=/root/config/prometheus.yml"]
    ports:
      - "6060:6060"
      - "8080:8080"
    environment:
      - ClickHouseUrl=tcp://clickhouse:9000
    depends_on:
      - clickhouse

  frontend:
    image: signoz/frontend:0.44.2
    container_name: signoz-frontend
    ports:
      - "3301:3301"
    environment:
      - FRONTEND_API_ENDPOINT=http://query-service:8080
    depends_on:
      - query-service

volumes:
  clickhouse-data:
```

### Task 3: Add SigNoz instructions to README
**File**: `README.md`
**Action**: modify
**Why**: Document how to start/stop SigNoz for development.

Add this section after the "Development Workflow" section (around line 50):

```markdown
### Running SigNoz (Trace Visualization)

SigNoz provides a UI for viewing distributed traces captured by OpenTelemetry.

**Start SigNoz:**
```bash
docker-compose -f docker-compose.signoz.yml up -d
```

**Access SigNoz UI:**
Open http://localhost:3301 in your browser.

**Stop SigNoz:**
```bash
docker-compose -f docker-compose.signoz.yml down
```

**Clean up SigNoz data:**
```bash
docker-compose -f docker-compose.signoz.yml down -v
```

**Note**: SigNoz is optional for development. The BAP server will work without it, but traces won't be visible.
```

## Verification

1. Verify OTel collector config exists:
```bash
ls -lh otel-collector-config.yaml
```

2. Verify docker-compose file exists:
```bash
ls -lh docker-compose.signoz.yml
```

3. Check docker-compose syntax:
```bash
docker-compose -f docker-compose.signoz.yml config
```

Should output the parsed configuration without errors.

4. Start SigNoz (requires Docker running):
```bash
docker-compose -f docker-compose.signoz.yml up -d
```

5. Wait 30 seconds for services to initialize, then check all 4 containers are running:
```bash
docker-compose -f docker-compose.signoz.yml ps
```

Should show 4 services in "Up" state.

6. Check OTLP HTTP endpoint is accessible:
```bash
curl -I http://localhost:4318/v1/traces
```

Should return `405 Method Not Allowed` (GET not allowed, but endpoint exists).

7. Access SigNoz UI:
```bash
open http://localhost:3301
```

Should show SigNoz dashboard (may take a minute to load on first start).

## Rollback

If something goes wrong:

1. Stop and remove SigNoz containers:
```bash
docker-compose -f docker-compose.signoz.yml down -v
```

2. Delete created files:
```bash
rm docker-compose.signoz.yml otel-collector-config.yaml
```

3. Restore README from git:
```bash
git checkout README.md
```
