# Plan 01-01: Install OpenTelemetry Packages and Create Tracing Module

**Phase**: 1 - SDK Foundation
**Depends on**: Nothing (first plan)
**Requirement(s)**: OTEL-01, OTEL-06

## Goal
OpenTelemetry packages installed and tracing.ts module created with SDK initialization.

## Context
This is the foundation for distributed tracing in the ONDC BAP application. We're installing the 6 core OpenTelemetry packages needed for auto-instrumentation of Express 5.x, HTTP clients, and ioredis 5.x. The tracing.ts module will initialize the NodeSDK with an OTLP HTTP exporter targeting SigNoz. This plan does NOT modify the server entry point (that's plan 01-03) to keep changes atomic and testable.

## Tasks

### Task 1: Install OpenTelemetry packages
**File**: `server/package.json`
**Action**: modify
**Why**: Add the 6 OpenTelemetry dependencies needed for auto-instrumentation and OTLP export.

Run from the server directory:

```bash
cd server && pnpm add @opentelemetry/sdk-node@^0.211.0 \
  @opentelemetry/api@^1.9.0 \
  @opentelemetry/auto-instrumentations-node@^0.69.0 \
  @opentelemetry/instrumentation@^0.211.0 \
  @opentelemetry/exporter-trace-otlp-http@^0.211.0 \
  @opentelemetry/semantic-conventions@^1.39.0
```

Verify the packages appear in `server/package.json` dependencies section.

### Task 2: Create tracing.ts module
**File**: `server/src/tracing.ts`
**Action**: create
**Why**: Initialize OpenTelemetry SDK with OTLP exporter, auto-instrumentations, and span limits configured for ONDC payloads.

Create the file with this exact content:

```typescript
// server/src/tracing.ts
// OpenTelemetry SDK initialization - MUST be imported first in entry point
import { NodeSDK } from '@opentelemetry/sdk-node';
import { getNodeAutoInstrumentations } from '@opentelemetry/auto-instrumentations-node';
import { OTLPTraceExporter } from '@opentelemetry/exporter-trace-otlp-http';
import { Resource } from '@opentelemetry/resources';
import {
  ATTR_SERVICE_NAME,
  ATTR_SERVICE_VERSION
} from '@opentelemetry/semantic-conventions';

// Initialize OTLP exporter pointing to SigNoz
const traceExporter = new OTLPTraceExporter({
  url: process.env.OTEL_EXPORTER_OTLP_ENDPOINT || 'http://localhost:4831/v1/traces',
  headers: {}, // Add auth headers if needed for cloud backends
});

// Configure resource attributes
const resource = new Resource({
  [ATTR_SERVICE_NAME]: process.env.OTEL_SERVICE_NAME || 'ondc-bap',
  [ATTR_SERVICE_VERSION]: '0.1.0',
  'deployment.environment': process.env.NODE_ENV || 'development',
});

// Initialize SDK with auto-instrumentations
const sdk = new NodeSDK({
  resource,
  traceExporter,
  spanLimits: {
    attributeValueLengthLimit: 16384, // 16KB for ONDC payloads
  },
  instrumentations: [
    getNodeAutoInstrumentations({
      // Disable noisy instrumentations
      '@opentelemetry/instrumentation-fs': { enabled: false },
      '@opentelemetry/instrumentation-dns': { enabled: false },

      // Configure ioredis to include key names
      '@opentelemetry/instrumentation-ioredis': {
        dbStatementSerializer: (cmdName, cmdArgs) => {
          return `${cmdName} ${cmdArgs[0] || ''}`;
        },
      },
    }),
  ],
});

// Start SDK
sdk.start();
console.log('[OpenTelemetry] SDK initialized');

// Graceful shutdown on SIGTERM
process.on('SIGTERM', () => {
  sdk
    .shutdown()
    .then(() => {
      console.log('[OpenTelemetry] SDK shut down successfully');
      process.exit(0);
    })
    .catch((error) => {
      console.error('[OpenTelemetry] Error shutting down SDK', error);
      process.exit(1);
    });
});
```

This file:
- Initializes NodeSDK with OTLP HTTP exporter
- Configures resource attributes (service name, version, environment)
- Sets span size limits to 16KB for large ONDC payloads
- Disables noisy fs/dns instrumentations
- Configures ioredis to include Redis key names in spans
- Handles graceful shutdown to flush buffered spans

### Task 3: Add OpenTelemetry environment variables to .env.example
**File**: `.env.example`
**Action**: modify
**Why**: Document the optional OTEL configuration variables so users can customize the exporter endpoint and service name.

Add this section after the existing NGROK_AUTHTOKEN line:

```env
# OpenTelemetry Configuration (optional)
# OTLP exporter endpoint for traces (defaults to http://localhost:4831/v1/traces)
# OTEL_EXPORTER_OTLP_ENDPOINT=http://localhost:4831/v1/traces
# Service name for traces (defaults to "ondc-bap")
# OTEL_SERVICE_NAME=ondc-bap
```

## Verification

1. Check package.json has all 6 OpenTelemetry packages:
```bash
cd server && grep -A 10 '"dependencies"' package.json | grep opentelemetry
```

You should see all 6 packages listed.

2. Verify tracing.ts file exists:
```bash
ls -lh server/src/tracing.ts
```

3. Verify the file has correct imports:
```bash
grep -c "import.*@opentelemetry" server/src/tracing.ts
```

Should output `6` (6 import statements).

4. Check .env.example was updated:
```bash
grep OTEL_EXPORTER_OTLP_ENDPOINT .env.example
```

Should show the new env var documentation.

## Rollback

If something goes wrong:

1. Remove OpenTelemetry packages:
```bash
cd server && pnpm remove @opentelemetry/sdk-node @opentelemetry/api @opentelemetry/auto-instrumentations-node @opentelemetry/instrumentation @opentelemetry/exporter-trace-otlp-http @opentelemetry/semantic-conventions
```

2. Delete tracing.ts:
```bash
rm server/src/tracing.ts
```

3. Restore .env.example from git:
```bash
git checkout .env.example
```
