# Plan 01-03: Import Tracing Module and Verify Auto-Instrumentation

**Phase**: 1 - SDK Foundation
**Depends on**: 01-01 (tracing.ts created), 01-02 (SigNoz running)
**Requirement(s)**: OTEL-01, OTEL-06

## Goal
Tracing imported first in server entry point and auto-instrumentation verified with visible spans in SigNoz.

## Context
This is the critical import order requirement for OpenTelemetry auto-instrumentation. The tracing.ts module MUST be imported before any other application code (especially before Express) to allow auto-instrumentation to patch module loaders. We'll modify the server entry point to add this import as the first line, then verify that HTTP/Express/Redis spans appear in SigNoz for a health check request.

## Tasks

### Task 1: Modify server entry point to import tracing first
**File**: `server/src/index.ts`
**Action**: modify
**Why**: Import tracing.ts before all other imports to enable auto-instrumentation monkey-patching.

Replace the current content with:

```typescript
import './tracing'; // MUST BE FIRST IMPORT

import ngrok from "@ngrok/ngrok";
import { app } from "./app";

const PORT = process.env.PORT || 4822;
const NGROK_DOMAIN = process.env.SUBSCRIBER_ID;

app.listen(PORT, async () => {
  console.log(`[Server] Running on http://localhost:${PORT}`);
  console.log(`[Server] tRPC endpoint: http://localhost:${PORT}/api/trpc`);
  console.log(`[Server] Health check: http://localhost:${PORT}/health`);
  console.log(`[Server] API docs: http://localhost:${PORT}/api/reference`);

  // Start ngrok tunnel in non-production environments if authtoken is configured
  const isProduction = process.env.NODE_ENV === "production";
  if (!isProduction && process.env.NGROK_AUTHTOKEN) {
    try {
      const listener = await ngrok.connect({
        addr: PORT,
        authtoken_from_env: true,
        domain: NGROK_DOMAIN,
      });
      console.log(`[ngrok] Tunnel established at: ${listener.url()}`);
    } catch (err) {
      console.error("[ngrok] Failed to establish tunnel:", err);
    }
  } else if (isProduction) {
    console.log("[ngrok] Skipped in production environment");
  }
});
```

The only change is adding `import './tracing';` as the FIRST LINE.

### Task 2: Verify tracing initialization in development
**File**: N/A (runtime verification)
**Action**: N/A
**Why**: Confirm OpenTelemetry SDK starts and auto-instrumentation loads without errors.

1. Ensure SigNoz is running:
```bash
docker-compose -f docker-compose.signoz.yml ps
```

All 4 services should be "Up".

2. Start the dev server:
```bash
pnpm dev:server
```

3. Check server logs for OpenTelemetry initialization message:
```
[OpenTelemetry] SDK initialized
```

If this message appears, tracing is initialized correctly.

4. Check for any import-related errors. The server should start normally with no errors.

### Task 3: Generate test trace by hitting health endpoint
**File**: N/A (runtime verification)
**Action**: N/A
**Why**: Create a test trace to verify auto-instrumentation is working and spans appear in SigNoz.

1. With dev server running, make a health check request:
```bash
curl http://localhost:4822/health
```

Should return:
```json
{"status":"Health OK!!","ready":true}
```

2. Wait 10-15 seconds for spans to be batched and exported to SigNoz.

3. Open SigNoz UI:
```bash
open http://localhost:3301
```

4. Navigate to "Services" tab. You should see service "ondc-bap" listed.

5. Click on "ondc-bap" service, then "Traces" tab.

6. You should see a trace with operation name "GET /health".

7. Click on the trace to view details. The trace should show:
   - Root span: HTTP GET /health
   - Child span: Express route handler
   - HTTP status: 200
   - Duration: <100ms typically

8. Check span attributes include:
   - `http.method`: "GET"
   - `http.target`: "/health"
   - `http.status_code`: 200
   - `service.name`: "ondc-bap"

### Task 4: Verify Redis instrumentation (if Redis operations occur)
**File**: N/A (runtime verification)
**Action**: N/A
**Why**: Confirm ioredis auto-instrumentation captures Redis commands with key names.

If your health check endpoint uses Redis (or any other endpoint that does):

1. Make a request that triggers Redis operations:
```bash
curl -X POST http://localhost:4822/api/trpc/gateway.search \
  -H "Content-Type: application/json" \
  -d '{"json":{"domain":"ONDC:FIS13","items":[{"descriptor":{"name":"Health Insurance"}}]}}'
```

2. In SigNoz, find this trace and expand it.

3. Look for child spans with names like:
   - `redis SET search:...`
   - `redis GET search:...`

4. Verify the span name includes the Redis command AND the key name (first argument), not just "redis.command".

## Verification

1. Verify import order in index.ts:
```bash
head -1 server/src/index.ts
```

Should output:
```
import './tracing'; // MUST BE FIRST IMPORT
```

2. Start dev server and check for SDK initialization:
```bash
pnpm dev:server 2>&1 | grep -i opentelemetry
```

Should show:
```
[OpenTelemetry] SDK initialized
```

3. Make health check request:
```bash
curl http://localhost:4822/health
```

Should return 200 OK.

4. Check SigNoz has received traces:
```bash
# Wait 15 seconds for export
sleep 15

# Query SigNoz query-service directly for services
curl -s http://localhost:8080/api/v1/services | grep -o '"ondc-bap"'
```

Should output: `"ondc-bap"` (confirms service is registered).

5. Manually verify in SigNoz UI:
   - Navigate to http://localhost:3301
   - Click "Services" → should see "ondc-bap"
   - Click "ondc-bap" → "Traces" → should see GET /health trace
   - Click trace → should see HTTP and Express spans

6. Verify auto-instrumentation is active by checking for Express spans:
```bash
# This requires the SigNoz API, alternatively check UI manually
# The presence of nested spans (HTTP → Express) confirms auto-instrumentation
```

## Rollback

If auto-instrumentation fails or causes issues:

1. Stop the dev server (Ctrl+C).

2. Remove tracing import from index.ts:
```bash
# Restore original index.ts from git
git checkout server/src/index.ts
```

3. Restart server:
```bash
pnpm dev:server
```

Server will run without tracing.

4. Debug tracing issues:
```bash
# Enable OpenTelemetry debug logging
OTEL_LOG_LEVEL=debug pnpm dev:server
```

Look for instrumentation registration messages:
```
[OpenTelemetry] Registered instrumentation: ExpressInstrumentation
[OpenTelemetry] Registered instrumentation: HttpInstrumentation
[OpenTelemetry] Registered instrumentation: IORedisInstrumentation
```

If these don't appear, the import order is wrong or packages aren't installed correctly.
