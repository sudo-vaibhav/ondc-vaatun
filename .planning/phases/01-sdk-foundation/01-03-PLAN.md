# Plan 01-03: Import Tracing Module and Verify Auto-Instrumentation

**Phase**: 1 - SDK Foundation
**Depends on**: 01-01 (tracing.ts created), 01-02 (SigNoz running)
**Requirement(s)**: OTEL-01, OTEL-06

## Goal
Tracing imported first in server entry point and auto-instrumentation verified with visible spans in SigNoz.

## Context
This is the critical import order requirement for OpenTelemetry auto-instrumentation. The tracing.ts module MUST be imported before any other application code (especially before Express) to allow auto-instrumentation to patch module loaders. We'll modify the server entry point to add this import as the first line, then verify that HTTP/Express/Redis spans appear in SigNoz for a health check request.

## Tasks

### Task 1: Add tracing import as first line in server entry point
**File**: `server/src/index.ts`
**Action**: modify
**Why**: Import tracing.ts before all other imports to enable auto-instrumentation monkey-patching.

Add `import './tracing'; // MUST BE FIRST IMPORT` as the very first line of the file, before all existing imports. Do NOT change any other code in the file.

The first few lines should look like:
```typescript
import './tracing'; // MUST BE FIRST IMPORT

import ngrok from "@ngrok/ngrok";
import { app } from "./app";
// ... rest unchanged
```

## Verification

### Code verification
1. Verify import order in index.ts:
```bash
head -1 server/src/index.ts
```
Should output: `import './tracing'; // MUST BE FIRST IMPORT`

### Runtime verification (requires SigNoz from Plan 01-02 running)

2. Ensure SigNoz is running:
```bash
docker-compose -f docker-compose.signoz.yml ps
```
All 4 services should be "Up".

3. Start dev server and check for SDK initialization:
```bash
pnpm dev:server
```
Should see `[OpenTelemetry] SDK initialized` in logs.

4. Make health check request:
```bash
curl http://localhost:4822/health
```
Should return 200 OK.

5. Wait 15 seconds, then check SigNoz has received traces:
```bash
sleep 15
curl -s http://localhost:4833/api/v1/services | grep -o '"ondc-bap"'
```
Should output: `"ondc-bap"` (confirms service is registered).

6. Manually verify in SigNoz UI at http://localhost:4830:
   - "Services" tab → should see "ondc-bap"
   - Click "ondc-bap" → "Traces" → should see GET /health trace
   - Click trace → should see HTTP and Express child spans
   - Span attributes should include: `http.method: GET`, `http.status_code: 200`, `service.name: ondc-bap`

7. Verify Redis instrumentation (trigger a search or endpoint that uses Redis):
```bash
curl -X POST http://localhost:4822/api/trpc/gateway.search \
  -H "Content-Type: application/json" \
  -d '{"json":{"domain":"ONDC:FIS13","items":[{"descriptor":{"name":"Health Insurance"}}]}}'
```
In SigNoz, find this trace and look for child spans like `redis SET search:...` with key names visible.

## Rollback

If auto-instrumentation fails or causes issues:

1. Stop the dev server (Ctrl+C).

2. Remove tracing import from index.ts:
```bash
# Restore original index.ts from git
git checkout server/src/index.ts
```

3. Restart server:
```bash
pnpm dev:server
```

Server will run without tracing.

4. Debug tracing issues:
```bash
# Enable OpenTelemetry debug logging
OTEL_LOG_LEVEL=debug pnpm dev:server
```

Look for instrumentation registration messages:
```
[OpenTelemetry] Registered instrumentation: ExpressInstrumentation
[OpenTelemetry] Registered instrumentation: HttpInstrumentation
[OpenTelemetry] Registered instrumentation: IORedisInstrumentation
```

If these don't appear, the import order is wrong or packages aren't installed correctly.
