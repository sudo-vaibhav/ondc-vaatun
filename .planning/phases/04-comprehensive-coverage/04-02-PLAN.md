---
phase: 04-comprehensive-coverage
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - server/src/trpc/routers/gateway.ts
autonomous: true

must_haves:
  truths:
    - "Init flow creates ondc.init span with traceparent stored in Redis"
    - "on_init callback creates linked span correlated to init via traceparent"
    - "Confirm flow creates ondc.confirm span with traceparent stored in Redis"
    - "on_confirm callback creates linked span with ondc.payment_url attribute"
    - "Status flow creates ondc.status span with traceparent stored in Redis"
    - "on_status callback creates linked span correlated to status via orderId lookup"
  artifacts:
    - path: "server/src/trpc/routers/gateway.ts"
      provides: "Tracing for init, confirm, status flows + their callbacks"
      contains: "ondc.init"
  key_links:
    - from: "server/src/trpc/routers/gateway.ts (init)"
      to: "server/src/lib/init-store.ts"
      via: "createInitEntry with traceparent parameter"
      pattern: "createInitEntry.*traceparent"
    - from: "server/src/trpc/routers/gateway.ts (onInit)"
      to: "server/src/lib/init-store.ts"
      via: "getInitEntry for trace restoration"
      pattern: "getInitEntry.*traceparent"
    - from: "server/src/trpc/routers/gateway.ts (confirm)"
      to: "server/src/lib/confirm-store.ts"
      via: "createConfirmEntry with traceparent parameter"
      pattern: "createConfirmEntry.*traceparent"
    - from: "server/src/trpc/routers/gateway.ts (onConfirm)"
      to: "server/src/lib/confirm-store.ts"
      via: "getConfirmEntry + payment_url extraction"
      pattern: "ondc\\.payment_url"
    - from: "server/src/trpc/routers/gateway.ts (status)"
      to: "server/src/lib/status-store.ts"
      via: "createStatusEntry with traceparent parameter"
      pattern: "createStatusEntry.*traceparent"
    - from: "server/src/trpc/routers/gateway.ts (onStatus)"
      to: "server/src/lib/status-store.ts"
      via: "getStatusEntry by orderId for trace restoration"
      pattern: "getStatusEntry.*traceparent"
---

<objective>
Add tracing to init/on_init, confirm/on_confirm, and status/on_status flows in gateway.ts, completing comprehensive coverage of all ONDC protocol operations.

Purpose: After Plan 01 established stores + select pattern + signing spans, this plan mechanically replicates the same tracing pattern to the 3 remaining flows. Special cases: on_confirm extracts `ondc.payment_url`, status uses orderId-based lookup.

Output: All 8 remaining gateway procedures (4 outbound + 4 callbacks) fully traced with ONDC attributes, linked spans, and error handling.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-comprehensive-coverage/CONTEXT.md
@.planning/phases/04-comprehensive-coverage/04-RESEARCH.md
@.planning/phases/04-comprehensive-coverage/04-01-SUMMARY.md
@server/src/trpc/routers/gateway.ts
@server/src/lib/init-store.ts
@server/src/lib/confirm-store.ts
@server/src/lib/status-store.ts
@server/src/lib/trace-context-store.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add tracing to init/on_init and confirm/on_confirm</name>
  <files>server/src/trpc/routers/gateway.ts</files>
  <action>
    Apply the EXACT same pattern from Plan 01's select/on_select tracing to the init and confirm flows. Reference the search/onSearch and select/onSelect patterns already in gateway.ts as templates.

    **Import changes (top of file):**
    - Add `getInitEntry` to the import from `../../lib/init-store` (currently imports `addInitResponse, createInitEntry`)
    - Add `getConfirmEntry` to the import from `../../lib/confirm-store` (currently imports `addConfirmResponse, createConfirmEntry`)

    **A. Trace the `init` procedure:**

    Wrap entire procedure body in `tracer.startActiveSpan("ondc.init", async (span) => { ... })`:
    1. Move `const messageId = uuidv7()` inside span callback
    2. Set ONDC attributes:
       - `ondc.transaction_id`: input.transactionId
       - `ondc.message_id`: messageId
       - `ondc.action`: "init"
       - `ondc.domain`: tenant.domainCode
       - `ondc.bpp_id`: input.bppId
       - `ondc.bpp_uri`: input.bppUri
    3. Serialize: `const traceparent = serializeTraceContext()` INSIDE span callback
    4. Pass `traceparent` as LAST param to `createInitEntry()` (8th param, after bppUri)
    5. Existing payload building, URL construction, ondcClient.send() stay as-is inside span
    6. try/catch/finally with span.recordException, span.setStatus, span.end()
    7. Return response inside span callback

    **B. Trace the `onInit` callback:**

    Restructure following onSearch/onSelect pattern:
    1. Extract `transactionId` and `messageId` from `input.context`
    2. Early return if `!transactionId || !messageId` (warn + ACK)
    3. `const entry = await getInitEntry(kv, transactionId, messageId)`
    4. `const originalSpanContext = restoreTraceContext(entry?.traceparent)`
    5. Warn if `!entry?.traceparent`
    6. Create linked span options:
       ```
       const spanOptions = createLinkedSpanOptions(originalSpanContext, {
         kind: SpanKind.SERVER,
         attributes: {
           "ondc.transaction_id": transactionId,
           "ondc.action": "on_init",
           "ondc.bpp_id": input.context?.bpp_id || "unknown",
           "ondc.bpp_uri": input.context?.bpp_uri || "unknown",
         },
       });
       ```
    7. Wrap in `tracer.startActiveSpan("ondc.on_init", spanOptions, async (span) => { ... })`
    8. Inside: call `addInitResponse()`, handle `input.error` with SpanStatusCode.ERROR
    9. try/catch/finally with span.recordException, span.end()

    **C. Trace the `confirm` procedure:**

    Same pattern as init. Wrap in `tracer.startActiveSpan("ondc.confirm", async (span) => { ... })`:
    1. Move `const messageId = input.messageId || uuidv7()` inside span callback
    2. Set ONDC attributes (same set: transaction_id, message_id, action="confirm", domain, bpp_id, bpp_uri)
    3. `const traceparent = serializeTraceContext()` INSIDE span
    4. Pass `traceparent` as LAST param to `createConfirmEntry()` (10th param, after amount)
    5. Existing payload, URL, send() stay as-is inside span
    6. try/catch/finally

    **D. Trace the `onConfirm` callback:**

    Same linked span pattern PLUS the `ondc.payment_url` special attribute:
    1. Extract `transactionId`, `messageId`, `orderId` from input
    2. Early return if `!transactionId || !messageId`
    3. `const entry = await getConfirmEntry(kv, transactionId, messageId)`
    4. Restore context, create linked span options with `ondc.action: "on_confirm"`
    5. Wrap in `tracer.startActiveSpan("ondc.on_confirm", spanOptions, async (span) => { ... })`
    6. **SPECIAL: Extract payment URL and add as span attribute:**
       ```typescript
       const paymentUrl = input.message?.order?.payments?.[0]?.url;
       if (paymentUrl) {
         span.setAttribute("ondc.payment_url", paymentUrl);
       }
       ```
    7. Call `addConfirmResponse()` with existing params
    8. Handle `input.error` with SpanStatusCode.ERROR
    9. try/catch/finally

    **Do NOT change:** search, onSearch, select, onSelect (already traced in Phase 3 / Plan 01).
  </action>
  <verify>
    Run `cd /Users/sudomakes/conductor/workspaces/ondc-vaatun/medan/server && npx tsc --noEmit 2>&1 | head -30`

    Verify patterns:
    - `grep -n "ondc.init" server/src/trpc/routers/gateway.ts` shows outbound and callback span names
    - `grep -n "ondc.confirm" server/src/trpc/routers/gateway.ts` shows outbound and callback span names
    - `grep -n "ondc.on_init" server/src/trpc/routers/gateway.ts` shows callback span name
    - `grep -n "ondc.on_confirm" server/src/trpc/routers/gateway.ts` shows callback span name
    - `grep -n "ondc.payment_url" server/src/trpc/routers/gateway.ts` shows payment URL attribute in onConfirm
    - `grep -n "getInitEntry" server/src/trpc/routers/gateway.ts` shows import and usage
    - `grep -n "getConfirmEntry" server/src/trpc/routers/gateway.ts` shows import and usage
  </verify>
  <done>
    init procedure wrapped in ondc.init span with traceparent passed to createInitEntry. onInit creates linked ondc.on_init span with BPP attributes. confirm procedure wrapped in ondc.confirm span with traceparent passed to createConfirmEntry. onConfirm creates linked ondc.on_confirm span with BPP attributes AND ondc.payment_url extraction. All handlers have uniform error handling. TypeScript compiles.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add tracing to status/on_status</name>
  <files>server/src/trpc/routers/gateway.ts</files>
  <action>
    Add tracing to status/on_status. This flow has a DIFFERENT store pattern from the others: status-store is keyed by orderId (not transactionId+messageId), and on_status retrieves entry by orderId.

    **Import changes (top of file):**
    - Add `getStatusEntry` to the import from `../../lib/status-store` (currently imports `addStatusResponse, createStatusEntry`)

    **A. Trace the `status` procedure:**

    Wrap in `tracer.startActiveSpan("ondc.status", async (span) => { ... })`:
    1. Move `const messageId = uuidv7()` inside span callback
    2. Set ONDC attributes:
       - `ondc.transaction_id`: input.transactionId
       - `ondc.message_id`: messageId
       - `ondc.action`: "status"
       - `ondc.domain`: tenant.domainCode
       - `ondc.bpp_id`: input.bppId
       - `ondc.bpp_uri`: input.bppUri
       - `ondc.order_id`: input.orderId (status-specific attribute)
    3. `const traceparent = serializeTraceContext()` INSIDE span
    4. Pass `traceparent` as LAST param to `createStatusEntry()` (6th param, after bppUri)
    5. Existing payload, URL, send() stay as-is inside span
    6. try/catch/finally

    **B. Trace the `onStatus` callback:**

    DIFFERENT from other callbacks because it uses orderId for lookup, not transactionId+messageId:

    1. Extract `orderId` from `input.message?.order?.id` (already exists in current code)
    2. Also extract `transactionId` from `input.context?.transaction_id` for span attributes
    3. Early return if `!orderId` (warn + ACK) -- this is the correlation key for status
    4. `const entry = await getStatusEntry(kv, orderId)` -- note: keyed by orderId ONLY, unlike other stores
    5. `const originalSpanContext = restoreTraceContext(entry?.traceparent)`
    6. Warn if `!entry?.traceparent`
    7. Create linked span options:
       ```
       const spanOptions = createLinkedSpanOptions(originalSpanContext, {
         kind: SpanKind.SERVER,
         attributes: {
           "ondc.transaction_id": transactionId || "unknown",
           "ondc.action": "on_status",
           "ondc.order_id": orderId,
           "ondc.bpp_id": input.context?.bpp_id || "unknown",
           "ondc.bpp_uri": input.context?.bpp_uri || "unknown",
         },
       });
       ```
    8. Wrap in `tracer.startActiveSpan("ondc.on_status", spanOptions, async (span) => { ... })`
    9. Inside: call `addStatusResponse(kv, orderId, input)` (same as current)
    10. Handle `input.error` with SpanStatusCode.ERROR (uniform pattern)
    11. try/catch/finally

    **Key differences from other callbacks:**
    - Correlation key is `orderId`, not `transactionId + messageId`
    - `getStatusEntry(kv, orderId)` takes 2 params (not 3)
    - Each poll response creates a NEW linked span (multiple on_status calls for same orderId appear as sibling spans in the trace, showing polling timeline)
    - `ondc.order_id` attribute added for easy filtering
  </action>
  <verify>
    Run `cd /Users/sudomakes/conductor/workspaces/ondc-vaatun/medan/server && npx tsc --noEmit 2>&1 | head -30`

    Verify patterns:
    - `grep -n "ondc.status" server/src/trpc/routers/gateway.ts` shows outbound span name
    - `grep -n "ondc.on_status" server/src/trpc/routers/gateway.ts` shows callback span name
    - `grep -n "getStatusEntry" server/src/trpc/routers/gateway.ts` shows import and usage
    - `grep -n "ondc.order_id" server/src/trpc/routers/gateway.ts` shows order_id attribute on status spans
    - `grep -c "startActiveSpan" server/src/trpc/routers/gateway.ts` should show 10+ occurrences (search, on_search, select, on_select, init, on_init, confirm, on_confirm, status, on_status)
  </verify>
  <done>
    status procedure wrapped in ondc.status span with traceparent passed to createStatusEntry. onStatus creates linked ondc.on_status span using orderId-based entry lookup. Both include proper ONDC attributes and uniform error handling. All 10 gateway procedures (5 outbound + 5 callbacks) are now fully traced.
  </done>
</task>

</tasks>

<verification>
1. TypeScript compilation: `cd server && npx tsc --noEmit` produces no new errors
2. All 5 outbound procedures (search, select, init, confirm, status) have `ondc.{action}` spans
3. All 5 callbacks (on_search, on_select, on_init, on_confirm, on_status) have linked `ondc.on_{action}` spans
4. on_confirm extracts `ondc.payment_url` attribute from payments response
5. on_status uses orderId-based entry lookup (different from other callbacks)
6. All callbacks have BPP identity attributes (bpp_id, bpp_uri)
7. All callbacks handle input.error with SpanStatusCode.ERROR uniformly
8. `grep -c "startActiveSpan" server/src/trpc/routers/gateway.ts` returns 10+
</verification>

<success_criteria>
- init/on_init, confirm/on_confirm, status/on_status all have traced spans
- on_confirm captures `ondc.payment_url` from payment response
- on_status uses orderId-based getStatusEntry lookup
- All callbacks create linked spans with BPP identity
- All callbacks handle errors uniformly (input.error -> SpanStatusCode.ERROR)
- No new TypeScript compilation errors
- Count of `startActiveSpan` in gateway.ts is 10+ (5 outbound + 5 callback spans)
</success_criteria>

<output>
After completion, create `.planning/phases/04-comprehensive-coverage/04-02-SUMMARY.md`
</output>
