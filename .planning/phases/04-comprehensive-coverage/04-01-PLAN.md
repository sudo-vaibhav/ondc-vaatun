---
phase: 04-comprehensive-coverage
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - server/src/lib/select-store.ts
  - server/src/lib/init-store.ts
  - server/src/lib/confirm-store.ts
  - server/src/lib/status-store.ts
  - server/src/trpc/routers/gateway.ts
  - server/src/lib/ondc/client.ts
autonomous: true

must_haves:
  truths:
    - "Select flow creates ondc.select span with traceparent stored in Redis"
    - "on_select callback creates linked span correlated to select via traceparent"
    - "Ed25519 signing appears as ondc.sign child span inside ondc.http.request"
    - "All 4 stores (select, init, confirm, status) have traceparent field on entry interface"
    - "Select/init/confirm stores use 30-minute TTL for trace correlation"
  artifacts:
    - path: "server/src/lib/select-store.ts"
      provides: "SelectEntry with traceparent, 30-min TTL"
      contains: "traceparent"
    - path: "server/src/lib/init-store.ts"
      provides: "InitEntry with traceparent, 30-min TTL"
      contains: "traceparent"
    - path: "server/src/lib/confirm-store.ts"
      provides: "ConfirmEntry with traceparent, 30-min TTL"
      contains: "traceparent"
    - path: "server/src/lib/status-store.ts"
      provides: "StatusEntry with traceparent (keeps 24h TTL)"
      contains: "traceparent"
    - path: "server/src/lib/ondc/client.ts"
      provides: "ondc.sign span wrapping signMessage()"
      contains: "ondc.sign"
  key_links:
    - from: "server/src/trpc/routers/gateway.ts (select)"
      to: "server/src/lib/select-store.ts"
      via: "createSelectEntry with traceparent parameter"
      pattern: "createSelectEntry.*traceparent"
    - from: "server/src/trpc/routers/gateway.ts (onSelect)"
      to: "server/src/lib/select-store.ts"
      via: "getSelectEntry for trace restoration"
      pattern: "getSelectEntry.*traceparent"
    - from: "server/src/lib/ondc/client.ts"
      to: "ondc.sign span"
      via: "tracer.startActiveSpan wrapping signMessage"
      pattern: "startActiveSpan.*ondc\\.sign"
---

<objective>
Extend all 4 stores with traceparent support, add full tracing to select/on_select flow, and instrument Ed25519 signing with timing spans.

Purpose: Establishes the store foundation for all remaining flows (init, confirm, status) and proves the pattern works end-to-end on select/on_select. The signing span adds cryptographic latency visibility to every outbound ONDC request.

Output: Modified store files with traceparent fields + 30-min TTL, traced select/on_select in gateway.ts, signing span in client.ts.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-comprehensive-coverage/CONTEXT.md
@.planning/phases/04-comprehensive-coverage/04-RESEARCH.md
@.planning/phases/03-async-callback-correlation/03-02-SUMMARY.md
@server/src/trpc/routers/gateway.ts
@server/src/lib/select-store.ts
@server/src/lib/init-store.ts
@server/src/lib/confirm-store.ts
@server/src/lib/status-store.ts
@server/src/lib/ondc/client.ts
@server/src/lib/trace-context-store.ts
@server/src/lib/search-store.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend all 4 stores with traceparent field and update TTLs</name>
  <files>
    server/src/lib/select-store.ts
    server/src/lib/init-store.ts
    server/src/lib/confirm-store.ts
    server/src/lib/status-store.ts
  </files>
  <action>
    For each of the 4 stores, apply these changes uniformly:

    **1. Add `traceparent?: string` to entry interface:**
    - SelectEntry: add `traceparent?: string` after `createdAt: number`
    - InitEntry: add `traceparent?: string` after `createdAt: number`
    - ConfirmEntry: add `traceparent?: string` after `createdAt: number`
    - StatusEntry: add `traceparent?: string` after `createdAt: number`

    **2. Add `traceparent` parameter to `create*Entry()` functions:**
    - `createSelectEntry`: Add `traceparent?: string` as the LAST parameter (8th param, after bppUri). Include `traceparent` in the entry object.
    - `createInitEntry`: Add `traceparent?: string` as the LAST parameter (8th param, after bppUri). Include `traceparent` in the entry object.
    - `createConfirmEntry`: Add `traceparent?: string` as the LAST parameter (10th param, after amount). Include `traceparent` in the entry object.
    - `createStatusEntry`: Add `traceparent?: string` as the LAST parameter (6th param, after bppUri). Include `traceparent` in the entry object.

    **3. Update `DEFAULT_STORE_TTL_MS`:**
    - select-store: Change from `10 * 60 * 1000` to `30 * 60 * 1000` (30 minutes)
    - init-store: Change from `10 * 60 * 1000` to `30 * 60 * 1000` (30 minutes)
    - confirm-store: Change from `10 * 60 * 1000` to `30 * 60 * 1000` (30 minutes)
    - status-store: KEEP at `24 * 60 * 60 * 1000` (24 hours) -- already exceeds 30 min, intentional for policy data

    **Important notes:**
    - All stores already have `get*Entry()` functions -- no new functions needed.
    - Do NOT change any other functions (addSelectResponse, getSelectResult, etc.)
    - The `traceparent` field is optional (`?`) for backward compatibility
  </action>
  <verify>
    Run `cd /Users/sudomakes/conductor/workspaces/ondc-vaatun/medan/server && npx tsc --noEmit 2>&1 | head -30` to check for TypeScript errors. Pre-existing errors unrelated to store changes are acceptable.

    Grep to confirm changes:
    - `grep -n "traceparent" server/src/lib/select-store.ts server/src/lib/init-store.ts server/src/lib/confirm-store.ts server/src/lib/status-store.ts` should show traceparent in all 4 files
    - `grep -n "30 \* 60 \* 1000" server/src/lib/select-store.ts server/src/lib/init-store.ts server/src/lib/confirm-store.ts` should show 30-min TTL in select, init, confirm
    - `grep -n "24 \* 60 \* 60 \* 1000" server/src/lib/status-store.ts` should confirm status-store keeps 24h TTL
  </verify>
  <done>
    All 4 store entry interfaces have `traceparent?: string`. All 4 `create*Entry()` functions accept optional `traceparent` parameter. Select/init/confirm stores use 30-min TTL. Status store keeps 24h TTL. TypeScript compiles without new errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add tracing to select/on_select and signing span to client.ts</name>
  <files>
    server/src/trpc/routers/gateway.ts
    server/src/lib/ondc/client.ts
  </files>
  <action>
    **A. Trace the `select` procedure in gateway.ts (lines ~192-305):**

    Follow the EXACT pattern from the `search` procedure (lines ~27-96). Wrap the entire procedure body in `tracer.startActiveSpan("ondc.select", async (span) => { ... })`:

    1. Move `const messageId = uuidv7()` inside the span callback
    2. Set ONDC attributes immediately after messageId:
       ```
       span.setAttribute("ondc.transaction_id", input.transactionId);
       span.setAttribute("ondc.message_id", messageId);
       span.setAttribute("ondc.action", "select");
       span.setAttribute("ondc.domain", tenant.domainCode);
       span.setAttribute("ondc.bpp_id", input.bppId);
       span.setAttribute("ondc.bpp_uri", input.bppUri);
       ```
    3. Call `const traceparent = serializeTraceContext()` INSIDE the span callback, AFTER attributes
    4. Pass `traceparent` as the last argument to `createSelectEntry()` (8th param)
    5. Wrap in try/catch/finally with span.recordException, span.setStatus, span.end()
    6. Return the response inside the span callback

    The existing payload building, URL construction, and ondcClient.send() calls stay as-is, just moved inside the span callback.

    **B. Trace the `onSelect` callback in gateway.ts (lines ~307-363):**

    Follow the EXACT pattern from `onSearch` (lines ~98-190). Restructure the handler:

    1. Extract `transactionId` and `messageId` from `input.context`
    2. Early return if `!transactionId || !messageId` (log warning, return ACK)
    3. Retrieve entry: `const entry = await getSelectEntry(kv, transactionId, messageId)`
    4. Restore context: `const originalSpanContext = restoreTraceContext(entry?.traceparent)`
    5. Log warning if `!entry?.traceparent`
    6. Create linked span options with SpanKind.SERVER and attributes:
       `ondc.transaction_id`, `ondc.action: "on_select"`, `ondc.bpp_id`, `ondc.bpp_uri`
    7. Wrap in `tracer.startActiveSpan("ondc.on_select", spanOptions, async (span) => { ... })`
    8. Inside span: call `addSelectResponse()`, handle `input.error` with SpanStatusCode.ERROR
    9. try/catch/finally with span.recordException and span.end()

    **Import changes for gateway.ts:**
    - Add `getSelectEntry` to the import from `../../lib/select-store` (line 15)
    - `serializeTraceContext`, `restoreTraceContext`, `createLinkedSpanOptions` are ALREADY imported (line 17-21)
    - `SpanKind` and `SpanStatusCode` are ALREADY imported (line 1)

    **C. Add signing span in client.ts (line 58):**

    Wrap the `this.tenant.signMessage(signingString)` call on line 58 in an `ondc.sign` span. The `signMessage` method is SYNCHRONOUS, so use a sync callback:

    ```typescript
    const signature = this.tracer.startActiveSpan("ondc.sign", (span) => {
      try {
        const sig = this.tenant.signMessage(signingString);
        span.setStatus({ code: 1 as typeof SpanStatusCode.OK });
        return sig;
      } catch (error) {
        span.recordException(error as Error);
        span.setStatus({
          code: 2 as typeof SpanStatusCode.ERROR,
          message: (error as Error).message,
        });
        throw error;
      } finally {
        span.end();
      }
    });
    ```

    Replace the existing line 58 (`const signature = this.tenant.signMessage(signingString);`) with the span-wrapped version. Keep the numeric literals for SpanStatusCode (`1` for OK, `2` for ERROR) matching the existing pattern in client.ts.

    **Do NOT change:**
    - The search/onSearch procedures (already traced in Phase 3)
    - The init/confirm/status procedures (Plan 02)
    - Any payload structures or URL building logic
    - The `send()` method (already has its own span)
  </action>
  <verify>
    Run `cd /Users/sudomakes/conductor/workspaces/ondc-vaatun/medan/server && npx tsc --noEmit 2>&1 | head -30` to check for TypeScript errors.

    Verify key patterns exist:
    - `grep -n "ondc.select" server/src/trpc/routers/gateway.ts` should show span name
    - `grep -n "ondc.on_select" server/src/trpc/routers/gateway.ts` should show callback span name
    - `grep -n "serializeTraceContext" server/src/trpc/routers/gateway.ts` should show at least 2 occurrences (search + select)
    - `grep -n "getSelectEntry" server/src/trpc/routers/gateway.ts` should show import and usage in onSelect
    - `grep -n "ondc.sign" server/src/lib/ondc/client.ts` should show signing span
    - `grep -n "createLinkedSpanOptions" server/src/trpc/routers/gateway.ts` should show at least 2 occurrences (onSearch + onSelect)
  </verify>
  <done>
    The `select` procedure wraps in `ondc.select` span, serializes traceparent, passes to createSelectEntry. The `onSelect` callback retrieves entry, restores trace context, creates linked `ondc.on_select` span with BPP attributes and error handling. The `createAuthorizationHeader` method wraps signMessage in `ondc.sign` span with timing. TypeScript compiles without new errors.
  </done>
</task>

</tasks>

<verification>
1. TypeScript compilation: `cd server && npx tsc --noEmit` produces no new errors
2. All 4 store interfaces contain `traceparent?: string`
3. Select procedure creates `ondc.select` span with ONDC attributes
4. onSelect callback creates linked `ondc.on_select` span with BPP identity
5. Signing creates `ondc.sign` child span inside HTTP request span
6. Select/init/confirm stores use 30-min TTL, status keeps 24h TTL
</verification>

<success_criteria>
- `select` procedure wrapped in `tracer.startActiveSpan("ondc.select", ...)` with attributes
- `onSelect` creates linked span via `createLinkedSpanOptions` with BPP identity
- `createAuthorizationHeader` wraps `signMessage` in `ondc.sign` span
- All 4 store entry interfaces include `traceparent?: string`
- All 4 `create*Entry` functions accept `traceparent` parameter
- No new TypeScript compilation errors
</success_criteria>

<output>
After completion, create `.planning/phases/04-comprehensive-coverage/04-01-SUMMARY.md`
</output>
