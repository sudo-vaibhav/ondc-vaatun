---
milestone: v2.0
audited: 2026-02-16
status: tech_debt
scores:
  requirements: 7/8
  phases: 5/5
  integration: 4/5
  flows: 5/8
gaps:
  requirements:
    - "OTEL-03: Callback linkage not effective on production callback path (compat router)"
  integration:
    - "ondc-compat.ts (REST) is a parallel execution path that bypasses all tRPC tracing"
  flows: []
tech_debt:
  - phase: all
    items:
      - "Compat router callbacks (/api/ondc/on_*) have no span creation or trace context restoration"
      - "Compat router outbound operations store entries without traceparent"
  - phase: 02-core-instrumentation
    items:
      - "SpanStatusCode used as numeric literals in client.ts instead of enum values"
  - phase: 05-error-classification-logging
    items:
      - "PinoInstrumentation trace field injection unreliable in development mode with pino-pretty transport"
---

# Milestone v2.0 Audit: Observability & Traceability

## Executive Summary

All 5 phases (12 plans) executed successfully. The tRPC code path has complete end-to-end tracing with callback correlation, error classification, and structured logging. **One architectural gap:** real BPP callbacks arrive at `/api/ondc/on_*` (compat REST router), which has no trace instrumentation. This means OTEL-03 (callback-to-parent linkage) is not effective on the actual production callback path.

**Recommendation:** Address the compat router gap before considering the milestone fully delivered. This is a known dual-path architecture issue, not a flaw in the tracing implementation itself.

## Requirements Coverage

| REQ-ID | Description | Status | Notes |
|--------|-------------|--------|-------|
| OTEL-01 | OTel SDK integrated with auto-instrumentation | **Satisfied** | tracing.ts imported first in index.ts; NodeSDK with auto-instrumentations |
| OTEL-02 | Every outgoing ONDC request creates span with payload | **Satisfied** | ONDCClient.send() creates ondc.http.request span on ALL paths (shared client) |
| OTEL-03 | Every callback linked to parent trace via transactionId | **Partial** | tRPC path: full linkage. Compat path (/api/ondc/on_*): no linkage. BPP callbacks use compat path. |
| OTEL-04 | Internal operations (Redis, signing) visible as child spans | **Satisfied** | ioredis auto-instrumented; ondc.sign span wraps Ed25519 signing |
| OTEL-05 | HTTP headers, bodies, timing captured in span attributes | **Satisfied** | Full request body, Authorization header, response body, status code captured |
| OTEL-06 | OTLP exporter configured for vendor-neutral export | **Satisfied** | OTLP HTTP exporter → SigNoz collector; docker-compose provided |
| OTEL-07 | Structured logging with trace context | **Satisfied** | Pino + PinoInstrumentation injects trace_id/span_id. Production JSON mode reliable. Dev pino-pretty mode may have trace field injection variance. |
| OTEL-08 | Error classification (BAP/gateway/BPP/network) | **Satisfied** | classifyErrorSource() in error-classifier.ts; error.source on all gateway error paths |

**Score: 7/8 requirements satisfied** (OTEL-03 partial due to compat router gap)

## Phase Verification

| Phase | Plans | Status | Deviations | Issues |
|-------|-------|--------|------------|--------|
| 1. SDK Foundation | 3/3 | Complete | None | None |
| 2. Core Instrumentation | 3/3 | Complete | None | SpanStatusCode numeric literals (cosmetic) |
| 3. Async Callback Correlation | 2/2 | Complete | None | Pattern only effective via tRPC path |
| 4. Comprehensive Coverage | 2/2 | Complete | None | Same compat router gap |
| 5. Error Classification & Logging | 2/2 | Complete | None | Resource API fix during execution |

**Score: 5/5 phases complete** (all plans executed with zero deviations)

## Cross-Phase Integration

| Integration Point | Status | Notes |
|-------------------|--------|-------|
| Phase 1 → 2: Auto-instrumentation before manual spans | **OK** | tracing.ts import order correct |
| Phase 2 → 3: tRPC span parents traceparent serialization | **OK** | startActiveSpan ensures correct context |
| Phase 3 → 4: Traceparent pattern across all stores | **OK** | All 5 stores have traceparent field |
| Phase 4 → 5: Error.source on existing span hierarchy | **OK** | Attributes added to all error paths |
| Cross-cutting: Compat router integration | **Gap** | No tracing in parallel REST path |

**Score: 4/5 integration points verified** (compat router gap)

## E2E Flow Results

| Flow | tRPC Path | Compat (Production) Path |
|------|-----------|--------------------------|
| Search → on_search | Complete | Outbound: HTTP span only. Callback: no span/linkage |
| Select → on_select | Complete | Same |
| Init → on_init | Complete | Same |
| Confirm → on_confirm | Complete | Same |
| Status → on_status | Complete | Same |
| Error flow (BPP 500) | Complete | HTTP client classification works; no outer span |
| Network failure | Complete | Same as error flow |
| Log-trace correlation | Complete | Production: works. Dev: trace fields may be absent |

**Score: 5/8 flows fully verified** (tRPC paths all pass; compat paths degrade gracefully)

## Tech Debt

### Compat Router Trace Gap (High Priority)

The codebase has two parallel execution paths:

1. **tRPC** (`/api/trpc`) — fully instrumented with spans, traceparent storage, callback correlation
2. **REST compat** (`/api/ondc`) — `ondc-compat.ts` with no tracing instrumentation

BPP callbacks arrive at `/api/ondc/on_*` because `bap_uri` is registered as `https://{subscriberId}/api/ondc`. This means:
- Outbound operations via frontend → tRPC → traced
- BPP callback responses → compat router → NOT traced (no span linkage)

**Impact:** The entire Phase 3 async correlation mechanism (traceparent in Redis → linked spans) is unreachable in the actual callback path.

**Fix options:**
- A. Add tracing to compat router callback handlers (replicate tRPC pattern)
- B. Route BPP callbacks through tRPC (change callback URL registration)
- C. Have compat callback handlers delegate to tRPC caller

### Minor Items

| Item | Phase | Severity |
|------|-------|----------|
| SpanStatusCode numeric literals instead of enum | Phase 2 | Low |
| pino-pretty dev mode trace field injection unreliable | Phase 5 | Low |
| tracing.ts retains 3 console.log calls (documented, correct) | Phase 5 | None (by design) |

## Conclusion

The tracing implementation is architecturally sound and works end-to-end through the tRPC path. The compat router gap is a pre-existing architectural concern (dual path) rather than a flaw in the v2.0 implementation. All 12 plans executed cleanly with zero deviations.

**Overall Status: Tech Debt — 7/8 requirements met, 1 architectural gap to address**

---
*Audited: 2026-02-16*
*Milestone: v2.0 Observability & Traceability*
